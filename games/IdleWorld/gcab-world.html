<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCAŒ≤ World - Economy Driven Browser Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght:400;700;900&family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #141827;
            --bg-tertiary: #1a1f35;
            --accent-silver: #c0c5ce;
            --accent-gold: #f4a261;
            --accent-green: #2a9d8f;
            --accent-red: #e76f51;
            --accent-blue: #457b9d;
            --text-primary: #e8eaed;
            --text-secondary: #a8b2c1;
            --border-color: #2a3047;
            --glow-silver: rgba(192, 197, 206, 0.3);
            --glow-gold: rgba(244, 162, 97, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1421 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background grid */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(var(--border-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.15;
            z-index: 0;
            animation: gridScroll 20s linear infinite;
        }

        @keyframes gridScroll {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-silver), var(--accent-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px var(--glow-silver);
            letter-spacing: 2px;
        }

        .currency-display {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .currency-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--glow-silver);
        }

        .currency-icon {
            font-size: 1.3rem;
        }

        .silver { color: var(--accent-silver); }
        .gold { color: var(--accent-gold); }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 4px 16px rgba(42, 157, 143, 0.4);
        }

        /* Main Content */
        .content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .screen-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(192, 197, 206, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-blue);
            box-shadow: 0 8px 24px rgba(69, 123, 157, 0.3);
        }

        .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--accent-silver);
        }

        .card-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .card-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 12px 24px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
            color: white;
            border-color: var(--accent-blue);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42, 157, 143, 0.5);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--accent-silver);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress bars */
        .progress-container {
            margin: 15px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(42, 157, 143, 0.5);
        }

        /* Action in progress */
        .action-active {
            background: linear-gradient(135deg, rgba(42, 157, 143, 0.1), rgba(69, 123, 157, 0.1));
            border-color: var(--accent-green);
        }

        /* Market listings */
        .market-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .market-item {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .market-item:hover {
            border-color: var(--accent-gold);
            box-shadow: 0 4px 16px var(--glow-gold);
        }

        .market-info {
            flex: 1;
            min-width: 200px;
        }

        .market-item-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .market-item-details {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .market-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* Input groups */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="number"],
        input[type="text"],
        select {
            flex: 1;
            padding: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(69, 123, 157, 0.3);
        }

        /* Workers */
        .worker-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .worker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .worker-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-green);
        }

        .worker-status {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-idle {
            background: rgba(231, 111, 81, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .status-working {
            background: rgba(42, 157, 143, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 350px;
            padding: 15px 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            border-color: var(--accent-green);
        }

        .notification.error {
            border-color: var(--accent-red);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-title {
                font-size: 1.8rem;
            }

            .currency-display {
                width: 100%;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                width: 100%;
            }
        }

        /* Loading animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-top">
                <h1 class="game-title">GCAŒ≤ WORLD</h1>
                <div class="currency-display">
                    <div class="currency-item">
                        <span class="currency-icon silver">ü•à</span>
                        <span><strong id="silverAmount">1000</strong> Silver</span>
                    </div>
                    <div class="currency-item">
                        <span class="currency-icon gold">ü•á</span>
                        <span><strong id="goldAmount">10</strong> Gold</span>
                    </div>
                </div>
            </div>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-screen="city">üèôÔ∏è City</button>
                <button class="nav-tab" data-screen="character">üë§ Character</button>
                <button class="nav-tab" data-screen="quests">üéØ Quests</button>
                <button class="nav-tab" data-screen="biome">üå≤ Biome</button>
                <button class="nav-tab" data-screen="crafting">üî® Crafting</button>
                <button class="nav-tab" data-screen="tools">‚öíÔ∏è Tools</button>
                <button class="nav-tab" data-screen="market">üè™ Market</button>
                <button class="nav-tab" data-screen="traders">ü§ù Traders</button>
                <button class="nav-tab" data-screen="shop">üíé Shop</button>
                <button class="nav-tab" data-screen="workers">üë∑ Workers</button>
                <button class="nav-tab" data-screen="island">üèùÔ∏è Island</button>
                <button class="nav-tab" data-screen="settings">‚öôÔ∏è Settings</button>
            </nav>
        </header>

        <!-- City Dashboard -->
        <div id="city" class="content active">
            <div class="screen">
                <h2 class="screen-title">üèôÔ∏è City Dashboard</h2>
                <p class="card-description">Welcome to GCAŒ≤ World! This is your central hub for managing your economy-driven adventure.</p>
                
                <div class="cards-grid">
                    <div class="card">
                        <h3 class="card-title">üìä Quick Stats</h3>
                        <div class="card-stats">
                            <div class="stat-row">
                                <span class="stat-label">Total Actions:</span>
                                <span class="stat-value" id="totalActions">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Items Owned:</span>
                                <span class="stat-value" id="totalItems">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Items Crafted:</span>
                                <span class="stat-value" id="itemsCrafted">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Trades Made:</span>
                                <span class="stat-value" id="tradesMade">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Active Workers:</span>
                                <span class="stat-value" id="activeWorkers">0/3</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Market Listings:</span>
                                <span class="stat-value" id="marketListings">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Current Biome:</span>
                                <span class="stat-value" id="currentBiome">Forest</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">üí∞ Economy Stats</h3>
                        <div class="card-stats">
                            <div class="stat-row">
                                <span class="stat-label">Silver Earned:</span>
                                <span class="stat-value" style="color: var(--accent-green);" id="silverEarned">0 ü•à</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Silver Spent:</span>
                                <span class="stat-value" style="color: var(--accent-red);" id="silverSpent">0 ü•à</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Net Profit:</span>
                                <span class="stat-value" id="netProfit">0 ü•à</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Next Tax:</span>
                                <span class="stat-value" id="nextTaxDisplay">--:--</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">üí° Recent Activity</h3>
                        <div id="recentActivity" style="max-height: 200px; overflow-y: auto;">
                            <p class="card-description">No recent activity yet. Start an action in the Biome!</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">üéØ Quick Actions</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-primary" onclick="switchScreen('character')">View Character</button>
                            <button class="btn btn-primary" onclick="switchScreen('quests')">View Quests</button>
                            <button class="btn btn-primary" onclick="switchScreen('biome')">Start Gathering</button>
                            <button class="btn btn-secondary" onclick="switchScreen('market')">Visit Market</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Character & Inventory Screen -->
        <div id="character" class="content">
            <div class="screen">
                <h2 class="screen-title">üë§ Character & Inventory</h2>
                <p class="card-description">Manage your character profile, view your inventory, and track your progression.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Character Profile -->
                    <div style="padding: 25px; background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); border: 2px solid var(--accent-gold); border-radius: 12px;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 4rem; margin-bottom: 10px;" id="characterAvatar">üë§</div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <input type="text" id="characterName" value="Adventurer" 
                                       style="text-align: center; font-size: 1.5rem; font-weight: 700; max-width: 200px;"
                                       onchange="updateCharacterName()">
                                <button class="btn btn-secondary" onclick="openAvatarPicker()" style="padding: 8px 12px; min-width: auto;">
                                    ‚úèÔ∏è
                                </button>
                            </div>
                            <div id="characterBadges" style="margin-top: 10px; display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                                <!-- Badges will appear here -->
                            </div>
                        </div>
                        
                        <div class="card-stats">
                            <div class="stat-row">
                                <span class="stat-label">Player Level:</span>
                                <span class="stat-value" id="playerLevel">1</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Total Wealth:</span>
                                <span class="stat-value" id="totalWealth">0 ü•à</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Achievements:</span>
                                <span class="stat-value"><span id="charAchievements">0</span>/30</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Biomes Unlocked:</span>
                                <span class="stat-value" id="biomesUnlocked">1/4</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Tools Owned:</span>
                                <span class="stat-value" id="toolsOwned">3</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Workers Hired:</span>
                                <span class="stat-value" id="workersHired">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div style="padding: 25px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 12px;">
                        <h3 class="card-title">üìä Lifetime Statistics</h3>
                        <div class="card-stats">
                            <div class="stat-row">
                                <span class="stat-label">Actions Completed:</span>
                                <span class="stat-value" id="charActionsComplete">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Items Crafted:</span>
                                <span class="stat-value" id="charItemsCrafted">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Trades Made:</span>
                                <span class="stat-value" id="charTradesMade">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Silver Earned:</span>
                                <span class="stat-value" style="color: var(--accent-green);" id="charSilverEarned">0 ü•à</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Silver Spent:</span>
                                <span class="stat-value" style="color: var(--accent-red);" id="charSilverSpent">0 ü•à</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Net Profit:</span>
                                <span class="stat-value" id="charNetProfit">0 ü•à</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Play Time:</span>
                                <span class="stat-value" id="playTime">0m</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Inventory Section -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="card-title">üéí Inventory</h3>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            Total Items: <span id="invTotalItems" style="color: var(--accent-gold); font-weight: 700;">0</span>
                        </div>
                    </div>
                    
                    <!-- Inventory Category Tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="filterInventory('all')" id="inv-filter-all" style="background: var(--accent-blue); border-color: var(--accent-blue);">All</button>
                        <button class="btn btn-secondary" onclick="filterInventory('tier1')" id="inv-filter-tier1">üå≤ Tier 1</button>
                        <button class="btn btn-secondary" onclick="filterInventory('tier2')" id="inv-filter-tier2">‚õ∞Ô∏è Tier 2</button>
                        <button class="btn btn-secondary" onclick="filterInventory('tier3')" id="inv-filter-tier3">üï≥Ô∏è Tier 3</button>
                        <button class="btn btn-secondary" onclick="filterInventory('crafted')" id="inv-filter-crafted">üî® Crafted</button>
                    </div>
                    
                    <div id="inventoryDisplay" class="cards-grid">
                        <!-- Inventory items will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Quests & Achievements Screen -->
        <div id="quests" class="content">
            <div class="screen">
                <h2 class="screen-title">üéØ Quests & Achievements</h2>
                <p class="card-description">Complete daily quests and unlock achievements for rewards!</p>
                
                <!-- Daily Quests -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="card-title">üìÖ Daily Quests</h3>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            Resets in: <span id="questResetTimer" style="color: var(--accent-gold); font-weight: 700;">--:--:--</span>
                        </div>
                    </div>
                    <div id="dailyQuests" class="cards-grid">
                        <!-- Daily quests will be rendered here -->
                    </div>
                </div>
                
                <!-- Achievements -->
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 class="card-title">üèÜ Achievements</h3>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <span id="achievementsUnlocked">0</span> / <span id="totalAchievements">0</span> Unlocked
                        </div>
                    </div>
                    
                    <!-- Achievement filters -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="filterAchievements('all')" id="filter-all">All</button>
                        <button class="btn btn-secondary" onclick="filterAchievements('unlocked')" id="filter-unlocked">Unlocked</button>
                        <button class="btn btn-secondary" onclick="filterAchievements('locked')" id="filter-locked">Locked</button>
                        <button class="btn btn-secondary" onclick="filterAchievements('gathering')" id="filter-gathering">Gathering</button>
                        <button class="btn btn-secondary" onclick="filterAchievements('economy')" id="filter-economy">Economy</button>
                        <button class="btn btn-secondary" onclick="filterAchievements('progression')" id="filter-progression">Progression</button>
                    </div>
                    
                    <div id="achievements" class="cards-grid">
                        <!-- Achievements will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Biome Activity Screen -->
        <div id="biome" class="content">
            <div class="screen">
                <h2 class="screen-title">üå≤ Biome Activities</h2>
                <p class="card-description">Gather resources through various activities. Each action takes time and may wear down your tools.</p>
                
                <!-- Biome selector -->
                <div class="input-group" style="margin-bottom: 20px;">
                    <select id="biomeSelect" onchange="changeBiome(this.value)" style="flex: 0 0 auto; min-width: 200px;">
                        <option value="forest">üå≤ Forest (Tier 1)</option>
                        <option value="mountains">‚õ∞Ô∏è Mountains (Tier 2)</option>
                        <option value="ocean">üåä Ocean (Tier 2)</option>
                        <option value="caves">üï≥Ô∏è Caves (Tier 3)</option>
                    </select>
                    <div style="flex: 1; padding: 12px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.85rem;">
                        <span id="biomeRequirement"></span>
                    </div>
                </div>
                
                <div class="cards-grid" id="biomeActions">
                    <!-- Actions will be dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Crafting Screen -->
        <div id="crafting" class="content">
            <div class="screen">
                <h2 class="screen-title">üî® Crafting Workshop</h2>
                <p class="card-description">Combine resources to create valuable items, tools, and equipment.</p>
                
                <div class="cards-grid" id="craftingRecipes">
                    <!-- Recipes will be dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Tools Screen -->
        <div id="tools" class="content">
            <div class="screen">
                <h2 class="screen-title">‚öíÔ∏è Tools & Equipment</h2>
                <p class="card-description">Manage your tools and equipment. Tools wear down with use and require repairs.</p>
                
                <div class="cards-grid" id="toolsList">
                    <!-- Tools will be dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Market Screen -->
        <div id="market" class="content">
            <div class="screen">
                <h2 class="screen-title">üè™ Player Market</h2>
                <p class="card-description">Player-driven marketplace. Buy and sell resources for Silver. 3% market fee on all sales.</p>
                
                <!-- Market Events -->
                <div id="marketEvents" style="margin-bottom: 20px;">
                    <!-- Dynamic market events will appear here -->
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 class="card-title">Create Listing</h3>
                    <div class="input-group">
                        <select id="listingItem">
                            <option value="">Select item...</option>
                            <optgroup label="Tier 1 - Forest">
                                <option value="wood">Wood</option>
                                <option value="stick">Stick</option>
                                <option value="berries">Berries</option>
                                <option value="herbs">Herbs</option>
                            </optgroup>
                            <optgroup label="Tier 2 - Mountains & Ocean">
                                <option value="stone">Stone</option>
                                <option value="iron_ore">Iron Ore</option>
                                <option value="copper_ore">Copper Ore</option>
                                <option value="coal">Coal</option>
                                <option value="fish">Fish</option>
                                <option value="seaweed">Seaweed</option>
                                <option value="pearl">Pearl</option>
                            </optgroup>
                            <optgroup label="Tier 3 - Caves">
                                <option value="silver_ore">Silver Ore</option>
                                <option value="gold_ore">Gold Ore</option>
                                <option value="gem">Gem</option>
                                <option value="crystal">Crystal</option>
                            </optgroup>
                            <optgroup label="Crafted Materials">
                                <option value="wooden_plank">Wooden Plank</option>
                                <option value="iron_bar">Iron Bar</option>
                                <option value="copper_bar">Copper Bar</option>
                                <option value="silver_bar">Silver Bar</option>
                                <option value="gold_bar">Gold Bar</option>
                                <option value="rope">Rope</option>
                                <option value="cloth">Cloth</option>
                            </optgroup>
                        </select>
                        <input type="number" id="listingQuantity" placeholder="Quantity" min="1">
                        <input type="number" id="listingPrice" placeholder="Price (Silver)" min="1">
                        <button class="btn btn-primary" onclick="createListing()">List Item</button>
                    </div>
                </div>

                <h3 class="card-title">Active Listings</h3>
                <div class="market-list" id="marketListings">
                    <p class="card-description">No items currently listed. Create a listing to start trading!</p>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 class="card-title">üìä Price History</h3>
                    <p class="card-description" style="margin-bottom: 15px;">Average market prices over the last 24 hours</p>
                    <div id="priceHistory" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        <!-- Price history will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- NPC Traders Screen -->
        <div id="traders" class="content">
            <div class="screen">
                <h2 class="screen-title">ü§ù NPC Traders</h2>
                <p class="card-description">Trade with NPCs whose prices fluctuate based on supply and demand. No market fees!</p>
                
                <!-- Tax notification -->
                <div style="padding: 15px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Periodic Tax</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-gold);">
                                <span id="dailyTaxAmount">10% Income</span>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                                Next payment: <span id="nextTaxTime">5:00</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="payTaxEarly()" style="min-width: 150px;">
                            Pay Now
                        </button>
                    </div>
                </div>
                
                <div class="cards-grid" id="npcTraders">
                    <!-- NPC traders will be dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Premium Shop Screen -->
        <div id="shop" class="content">
            <div class="screen">
                <h2 class="screen-title">üíé Premium Shop</h2>
                <p class="card-description">Purchase quality-of-life upgrades, boosts, and cosmetics with Gold. No pay-to-win!</p>
                
                <!-- Wallet Connection & Gold Store -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- MetaMask Wallet -->
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(244, 162, 97, 0.2), rgba(255, 215, 0, 0.2)); border: 2px solid var(--accent-gold); border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <div style="font-size: 2rem;">ü¶ä</div>
                            <div style="font-size: 1.2rem; font-weight: 700;">MetaMask Wallet</div>
                        </div>
                        <div id="walletStatus">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Status: Not Connected</div>
                            <button class="btn btn-primary" onclick="connectWallet()" id="connectWalletBtn">
                                Connect Wallet
                            </button>
                        </div>
                        <div id="walletConnected" style="display: none;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Connected Address:</div>
                            <div style="font-family: monospace; font-size: 0.85rem; color: var(--accent-green); word-break: break-all; margin-bottom: 10px;" id="walletAddress">0x...</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Network:</div>
                            <div style="font-size: 0.95rem; font-weight: 700; color: var(--accent-blue); margin-bottom: 10px;" id="walletNetwork">Base</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Balance:</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-gold); margin-bottom: 15px;" id="walletBalance">0 ETH</div>
                            <button class="btn btn-secondary" onclick="disconnectWallet()">
                                Disconnect
                            </button>
                        </div>
                    </div>
                    
                    <!-- Gold Store -->
                    <div style="padding: 20px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <div style="font-size: 2rem;">üè™</div>
                            <div style="font-size: 1.2rem; font-weight: 700;">Buy Gold with ETH</div>
                        </div>
                        <div id="goldStorePackages">
                            <!-- Gold packages will be shown here -->
                        </div>
                    </div>
                </div>
                
                <!-- Gold Balance & Exchange -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(244, 162, 97, 0.2), rgba(255, 215, 0, 0.2)); border: 2px solid var(--accent-gold); border-radius: 10px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Your Gold Balance</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent-gold);">
                            <span id="shopGoldBalance">10</span> ü•á
                        </div>
                    </div>
                    
                    <div style="padding: 20px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 10px;">
                        <div style="font-size: 0.9rem; font-weight: 700; margin-bottom: 10px;">Silver ‚Üí Gold Exchange</div>
                        <div class="input-group" style="margin-bottom: 10px;">
                            <input type="number" id="silverToExchange" placeholder="Silver amount" min="100" step="100" value="1000">
                            <div style="padding: 12px; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 8px; font-weight: 700; color: var(--accent-gold);">
                                = <span id="goldToReceive">1</span> ü•á
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">
                            Exchange rate: 1000 Silver = 1 Gold
                        </div>
                        <button class="btn btn-primary" onclick="exchangeSilverForGold()">Exchange</button>
                    </div>
                </div>
                
                <!-- Active Boosts -->
                <div id="activeBoosts" style="margin-bottom: 30px;">
                    <!-- Active boosts will be shown here -->
                </div>
                
                <!-- Shop Categories -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="filterShop('all')" id="shop-filter-all" style="background: var(--accent-blue); border-color: var(--accent-blue);">All</button>
                    <button class="btn btn-secondary" onclick="filterShop('boosts')" id="shop-filter-boosts">‚ö° Boosts</button>
                    <button class="btn btn-secondary" onclick="filterShop('convenience')" id="shop-filter-convenience">üéØ Convenience</button>
                    <button class="btn btn-secondary" onclick="filterShop('expansion')" id="shop-filter-expansion">üì¶ Expansion</button>
                    <button class="btn btn-secondary" onclick="filterShop('cosmetic')" id="shop-filter-cosmetic">‚ú® Cosmetic</button>
                </div>
                
                <div class="cards-grid" id="shopItems">
                    <!-- Shop items will be dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Workers Screen -->
        <div id="workers" class="content">
            <div class="screen">
                <h2 class="screen-title">üë∑ Workers</h2>
                <p class="card-description">Hire and manage workers for passive resource generation. Workers gain experience, level up, and can be specialized!</p>
                
                <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <h3 class="card-title">Hire Worker</h3>
                        <div class="input-group" style="margin-bottom: 10px;">
                            <select id="workerTypeSelect" style="flex: 1;">
                                <option value="general">General Worker (500 Silver)</option>
                                <option value="lumberjack">Lumberjack (800 Silver) - Wood +30%</option>
                                <option value="miner">Miner (800 Silver) - Mining +30%</option>
                                <option value="fisherman">Fisherman (800 Silver) - Fishing +30%</option>
                                <option value="gatherer">Gatherer (700 Silver) - Gathering +25%</option>
                                <option value="craftsman">Craftsman (1000 Silver) - Crafting +40%</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="hireWorker()">Hire Worker</button>
                    </div>
                    
                    <div style="flex: 1; min-width: 250px; padding: 20px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 10px;">
                        <div style="font-size: 0.9rem; font-weight: 700; margin-bottom: 10px;">Worker Capacity</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-gold);">
                            <span id="workerCount">0</span> / <span id="maxWorkers">3</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                            Upgrade capacity with Gold
                        </div>
                    </div>
                </div>

                <div id="workersList">
                    <!-- Workers will be dynamically generated -->
                </div>
            </div>
        </div>

        <!-- Island Screen -->
        <div id="island" class="content">
            <div class="screen">
                <h2 class="screen-title">üèùÔ∏è Your Island</h2>
                <p class="card-description">Your personal space for cosmetic improvements and light production. Unlock with Gold!</p>
                
                <div class="cards-grid">
                    <div class="card">
                        <h3 class="card-title">üè° Island Status</h3>
                        <div class="card-stats">
                            <div class="stat-row">
                                <span class="stat-label">Level:</span>
                                <span class="stat-value" id="islandLevel">1</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Buildings:</span>
                                <span class="stat-value" id="islandBuildings">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Daily Bonus:</span>
                                <span class="stat-value" id="islandBonus">+0 Silver</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">üèóÔ∏è Available Buildings</h3>
                        <p class="card-description" style="margin-bottom: 15px;">Unlock Premium to build on your island!</p>
                        <button class="btn btn-secondary" disabled>Requires Premium</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settings" class="content">
            <div class="screen">
                <h2 class="screen-title">‚öôÔ∏è Settings</h2>
                
                <div class="cards-grid">
                    <div class="card">
                        <h3 class="card-title">üîä Audio Settings</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <!-- Music Controls -->
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <label style="font-weight: 700;">üéµ Background Music</label>
                                    <button class="btn btn-secondary" onclick="toggleMusic()" id="musicToggle" style="padding: 6px 12px; min-width: 80px;">
                                        <span id="musicStatus">ON</span>
                                    </button>
                                </div>
                                <input type="range" min="0" max="100" value="30" 
                                       oninput="setMusicVolume(this.value)" 
                                       id="musicVolumeSlider"
                                       style="width: 100%; accent-color: var(--accent-gold);">
                                <div style="text-align: center; font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                                    Volume: <span id="musicVolumeDisplay">30</span>%
                                </div>
                            </div>
                            
                            <!-- Sound Effects Controls -->
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <label style="font-weight: 700;">üîî Sound Effects</label>
                                    <button class="btn btn-secondary" onclick="toggleSFX()" id="sfxToggle" style="padding: 6px 12px; min-width: 80px;">
                                        <span id="sfxStatus">ON</span>
                                    </button>
                                </div>
                                <input type="range" min="0" max="100" value="50" 
                                       oninput="setSFXVolume(this.value)" 
                                       id="sfxVolumeSlider"
                                       style="width: 100%; accent-color: var(--accent-blue);">
                                <div style="text-align: center; font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                                    Volume: <span id="sfxVolumeDisplay">50</span>%
                                </div>
                            </div>
                            
                            <!-- Music Track Selection -->
                            <div>
                                <label style="font-weight: 700; display: block; margin-bottom: 8px;">üéº Music Track</label>
                                <select id="trackSelect" onchange="changeTrack(this.value)" 
                                        style="width: 100%; padding: 10px; background: var(--bg-primary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                                    <option value="ambient">Ambient Exploration</option>
                                    <option value="upbeat">Upbeat Trading</option>
                                    <option value="chill">Chill Crafting</option>
                                    <option value="adventure">Adventure Theme</option>
                                </select>
                            </div>
                            
                            <button class="btn btn-secondary" onclick="testSound()">
                                üîä Test Sound
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">üíæ Save & Load</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button class="btn btn-primary" onclick="saveGame()">üíæ Save Game</button>
                            <button class="btn btn-secondary" onclick="loadGame()">üìÇ Load Game</button>
                            <button class="btn btn-secondary" onclick="resetGame()">üîÑ Reset Game</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">üìä Game Info</h3>
                        <div class="card-stats">
                            <div class="stat-row">
                                <span class="stat-label">Version:</span>
                                <span class="stat-value">Beta 1.0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Save Status:</span>
                                <span class="stat-value" id="saveStatus">Auto-Save On</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Last Save:</span>
                                <span class="stat-value" id="lastSave">Never</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">‚ÑπÔ∏è About</h3>
                        <p class="card-description">
                            GCAŒ≤ World is an economy-driven browser game focused on resource management, 
                            player-driven markets, and strategic planning. Build your wealth through smart 
                            trading and efficient resource gathering!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            silver: 1000,
            gold: 10,
            inventory: {
                // Tier 1 - Forest
                wood: 0,
                stick: 0,
                berries: 0,
                herbs: 0,
                
                // Tier 2 - Mountains & Ocean
                stone: 0,
                iron_ore: 0,
                copper_ore: 0,
                coal: 0,
                fish: 0,
                seaweed: 0,
                pearl: 0,
                
                // Tier 3 - Caves
                silver_ore: 0,
                gold_ore: 0,
                gem: 0,
                crystal: 0,
                
                // Crafted Items
                wooden_plank: 0,
                iron_bar: 0,
                copper_bar: 0,
                silver_bar: 0,
                gold_bar: 0,
                rope: 0,
                cloth: 0
            },
            tools: {
                basic_axe: { durability: 100, maxDurability: 100 },
                basic_pickaxe: { durability: 100, maxDurability: 100 },
                basic_fishing_rod: { durability: 100, maxDurability: 100 }
            },
            workers: [],
            marketListings: [],
            activeActions: {},
            stats: {
                totalActions: 0,
                actionsComplete: 0,
                itemsCrafted: 0,
                tradesMade: 0,
                silverSpent: 0,
                silverEarned: 0
            },
            activityLog: [],
            island: {
                level: 1,
                buildings: 0
            },
            progress: {
                currentBiome: 'forest',
                unlockedBiomes: ['forest'],
                tier: 1
            },
            economy: {
                priceHistory: {},
                npcTraders: {},
                currentEvent: null,
                eventEndTime: null,
                lastTaxPayment: Date.now(),
                taxRate: 0.10, // 10% of earned silver
                taxType: 'income', // 'income' or 'wealth'
                silverAtLastTax: 0
            },
            quests: {
                daily: [],
                lastDailyReset: Date.now(),
                completedToday: []
            },
            achievements: {},
            shop: {
                purchased: [],
                activeBoosts: {}
            },
            character: {
                name: 'Adventurer',
                avatar: 'üë§',
                level: 1,
                xp: 0,
                xpToNext: 1000,
                startTime: Date.now()
            },
            wallet: {
                connected: false,
                address: null,
                balance: 0,
                network: null
            },
            audio: {
                musicEnabled: true,
                sfxEnabled: true,
                musicVolume: 0.3,
                sfxVolume: 0.5,
                currentTrack: 'Chill Crafting'
            }
        };

        // Biome-specific Actions
        const biomes = {
            forest: {
                name: 'Forest',
                icon: 'üå≤',
                tier: 1,
                requirement: 'Available from start',
                actions: [
                    {
                        id: 'chop_wood',
                        name: 'Chop Wood',
                        icon: 'ü™µ',
                        description: 'Chop trees for wood',
                        duration: 5000,
                        cost: 10,
                        reward: { wood: 3, stick: 2, silver: 15 },
                        tool: 'basic_axe',
                        toolWear: 5
                    },
                    {
                        id: 'gather_berries',
                        name: 'Gather Berries',
                        icon: 'ü´ê',
                        description: 'Pick wild berries',
                        duration: 4000,
                        cost: 5,
                        reward: { berries: 5, silver: 10 },
                        tool: null,
                        toolWear: 0
                    },
                    {
                        id: 'collect_herbs',
                        name: 'Collect Herbs',
                        icon: 'üåø',
                        description: 'Harvest medicinal herbs',
                        duration: 6000,
                        cost: 8,
                        reward: { herbs: 3, silver: 20 },
                        tool: null,
                        toolWear: 0
                    },
                    {
                        id: 'gather_sticks',
                        name: 'Gather Sticks',
                        icon: 'ü¶¥',
                        description: 'Collect fallen branches',
                        duration: 3000,
                        cost: 5,
                        reward: { stick: 8, silver: 8 },
                        tool: null,
                        toolWear: 0
                    }
                ]
            },
            mountains: {
                name: 'Mountains',
                icon: '‚õ∞Ô∏è',
                tier: 2,
                requirement: 'Requires: 100 Stone OR 50 Iron Bar',
                actions: [
                    {
                        id: 'mine_stone',
                        name: 'Mine Stone',
                        icon: '‚õèÔ∏è',
                        description: 'Extract stone from quarry',
                        duration: 8000,
                        cost: 15,
                        reward: { stone: 5, silver: 30 },
                        tool: 'basic_pickaxe',
                        toolWear: 8
                    },
                    {
                        id: 'mine_iron',
                        name: 'Mine Iron Ore',
                        icon: '‚öôÔ∏è',
                        description: 'Extract iron ore',
                        duration: 10000,
                        cost: 20,
                        reward: { iron_ore: 3, stone: 2, silver: 45 },
                        tool: 'basic_pickaxe',
                        toolWear: 10
                    },
                    {
                        id: 'mine_copper',
                        name: 'Mine Copper Ore',
                        icon: 'üü†',
                        description: 'Extract copper ore',
                        duration: 9000,
                        cost: 18,
                        reward: { copper_ore: 3, stone: 1, silver: 40 },
                        tool: 'basic_pickaxe',
                        toolWear: 9
                    },
                    {
                        id: 'mine_coal',
                        name: 'Mine Coal',
                        icon: '‚ö´',
                        description: 'Extract coal for fuel',
                        duration: 7000,
                        cost: 12,
                        reward: { coal: 4, silver: 25 },
                        tool: 'basic_pickaxe',
                        toolWear: 6
                    }
                ]
            },
            ocean: {
                name: 'Ocean',
                icon: 'üåä',
                tier: 2,
                requirement: 'Requires: 50 Fish OR Fishing Rod (Iron)',
                actions: [
                    {
                        id: 'fish',
                        name: 'Go Fishing',
                        icon: 'üé£',
                        description: 'Catch fish from the ocean',
                        duration: 6000,
                        cost: 10,
                        reward: { fish: 5, silver: 25 },
                        tool: 'basic_fishing_rod',
                        toolWear: 4
                    },
                    {
                        id: 'collect_seaweed',
                        name: 'Collect Seaweed',
                        icon: 'üåä',
                        description: 'Harvest seaweed',
                        duration: 5000,
                        cost: 8,
                        reward: { seaweed: 6, silver: 18 },
                        tool: null,
                        toolWear: 0
                    },
                    {
                        id: 'dive_pearls',
                        name: 'Dive for Pearls',
                        icon: 'ü¶™',
                        description: 'Dive for rare pearls',
                        duration: 12000,
                        cost: 25,
                        reward: { pearl: 1, seaweed: 2, silver: 80 },
                        tool: null,
                        toolWear: 0
                    }
                ]
            },
            caves: {
                name: 'Caves',
                icon: 'üï≥Ô∏è',
                tier: 3,
                requirement: 'Requires: 100 Silver Ore OR Advanced Pickaxe',
                actions: [
                    {
                        id: 'mine_silver_ore',
                        name: 'Mine Silver Ore',
                        icon: '‚ö™',
                        description: 'Extract valuable silver ore',
                        duration: 15000,
                        cost: 40,
                        reward: { silver_ore: 3, stone: 2, silver: 100 },
                        tool: 'basic_pickaxe',
                        toolWear: 15
                    },
                    {
                        id: 'mine_gold_ore',
                        name: 'Mine Gold Ore',
                        icon: 'üü°',
                        description: 'Extract precious gold ore',
                        duration: 18000,
                        cost: 50,
                        reward: { gold_ore: 2, silver: 150 },
                        tool: 'basic_pickaxe',
                        toolWear: 18
                    },
                    {
                        id: 'mine_gems',
                        name: 'Mine Gems',
                        icon: 'üíé',
                        description: 'Search for precious gems',
                        duration: 20000,
                        cost: 60,
                        reward: { gem: 1, crystal: 2, silver: 200 },
                        tool: 'basic_pickaxe',
                        toolWear: 20
                    },
                    {
                        id: 'mine_crystals',
                        name: 'Mine Crystals',
                        icon: 'üîÆ',
                        description: 'Extract magical crystals',
                        duration: 16000,
                        cost: 45,
                        reward: { crystal: 4, silver: 120 },
                        tool: 'basic_pickaxe',
                        toolWear: 16
                    }
                ]
            }
        };

        // Crafting Recipes
        const craftingRecipes = [
            // Basic Materials
            {
                id: 'wooden_plank',
                name: 'Wooden Plank',
                icon: 'ü™µ',
                description: 'Process wood into planks',
                tier: 1,
                duration: 3000,
                cost: 5,
                ingredients: { wood: 3 },
                output: { wooden_plank: 2 },
                silver: 10
            },
            {
                id: 'rope',
                name: 'Rope',
                icon: 'ü™¢',
                description: 'Craft rope from herbs',
                tier: 1,
                duration: 4000,
                cost: 8,
                ingredients: { herbs: 5, stick: 2 },
                output: { rope: 1 },
                silver: 15
            },
            
            // Metal Bars
            {
                id: 'iron_bar',
                name: 'Iron Bar',
                icon: '‚öôÔ∏è',
                description: 'Smelt iron ore into bars',
                tier: 2,
                duration: 8000,
                cost: 20,
                ingredients: { iron_ore: 3, coal: 1 },
                output: { iron_bar: 1 },
                silver: 50
            },
            {
                id: 'copper_bar',
                name: 'Copper Bar',
                icon: 'üü†',
                description: 'Smelt copper ore into bars',
                tier: 2,
                duration: 7000,
                cost: 18,
                ingredients: { copper_ore: 3, coal: 1 },
                output: { copper_bar: 1 },
                silver: 45
            },
            {
                id: 'silver_bar',
                name: 'Silver Bar',
                icon: '‚ö™',
                description: 'Smelt silver ore into bars',
                tier: 3,
                duration: 12000,
                cost: 50,
                ingredients: { silver_ore: 3, coal: 2 },
                output: { silver_bar: 1 },
                silver: 150
            },
            {
                id: 'gold_bar',
                name: 'Gold Bar',
                icon: 'üü°',
                description: 'Smelt gold ore into bars',
                tier: 3,
                duration: 15000,
                cost: 80,
                ingredients: { gold_ore: 2, coal: 2 },
                output: { gold_bar: 1 },
                silver: 250
            },
            
            // Tools
            {
                id: 'iron_axe',
                name: 'Iron Axe',
                icon: 'ü™ì',
                description: 'Craft a durable iron axe',
                tier: 2,
                duration: 10000,
                cost: 100,
                ingredients: { iron_bar: 2, wooden_plank: 1, rope: 1 },
                output: { iron_axe: 1 },
                silver: 0,
                toolCraft: true
            },
            {
                id: 'iron_pickaxe',
                name: 'Iron Pickaxe',
                icon: '‚õèÔ∏è',
                description: 'Craft a sturdy iron pickaxe',
                tier: 2,
                duration: 10000,
                cost: 100,
                ingredients: { iron_bar: 3, stick: 2 },
                output: { iron_pickaxe: 1 },
                silver: 0,
                toolCraft: true
            },
            {
                id: 'iron_fishing_rod',
                name: 'Iron Fishing Rod',
                icon: 'üé£',
                description: 'Craft a reliable fishing rod',
                tier: 2,
                duration: 8000,
                cost: 80,
                ingredients: { iron_bar: 1, rope: 2, stick: 1 },
                output: { iron_fishing_rod: 1 },
                silver: 0,
                toolCraft: true
            }
        ];

        // NPC Trader Definitions
        const npcTraderTemplates = {
            lumberjack: {
                name: 'Timber Tom',
                icon: 'ü™ì',
                description: 'A woodworker who deals in forest goods',
                buys: ['wood', 'stick', 'berries', 'herbs'],
                sells: ['wood', 'stick', 'wooden_plank'],
                baseMultiplier: 1.0
            },
            miner: {
                name: 'Rocky Rhodes',
                icon: '‚õèÔ∏è',
                description: 'A grizzled miner with rare ores',
                buys: ['stone', 'iron_ore', 'copper_ore', 'coal'],
                sells: ['stone', 'iron_ore', 'copper_ore', 'coal', 'iron_bar', 'copper_bar'],
                baseMultiplier: 1.2
            },
            fisherman: {
                name: 'Captain Krill',
                icon: 'üé£',
                description: 'A salty sailor with ocean treasures',
                buys: ['fish', 'seaweed', 'pearl'],
                sells: ['fish', 'seaweed'],
                baseMultiplier: 1.1
            },
            jeweler: {
                name: 'Gemma Sparkle',
                icon: 'üíé',
                description: 'An elegant merchant of precious items',
                buys: ['gem', 'crystal', 'pearl', 'gold_ore', 'silver_ore'],
                sells: ['silver_bar', 'gold_bar'],
                baseMultiplier: 1.5
            },
            merchant: {
                name: 'Marco the Wanderer',
                icon: 'üéí',
                description: 'A traveling merchant with varied goods',
                buys: ['rope', 'cloth', 'wooden_plank'],
                sells: ['rope', 'berries', 'herbs', 'coal'],
                baseMultiplier: 0.9
            }
        };

        // Base prices for all items
        const basePrices = {
            // Tier 1
            wood: 5,
            stick: 2,
            berries: 3,
            herbs: 7,
            
            // Tier 2
            stone: 8,
            iron_ore: 15,
            copper_ore: 12,
            coal: 6,
            fish: 6,
            seaweed: 4,
            pearl: 80,
            
            // Tier 3
            silver_ore: 40,
            gold_ore: 60,
            gem: 100,
            crystal: 45,
            
            // Crafted
            wooden_plank: 12,
            iron_bar: 50,
            copper_bar: 40,
            silver_bar: 150,
            gold_bar: 250,
            rope: 20,
            cloth: 25
        };

        // Market Events
        const marketEvents = [
            {
                id: 'wood_shortage',
                name: 'Wood Shortage',
                icon: 'ü™µ',
                description: 'A construction boom has created high demand for wood!',
                duration: 300000, // 5 minutes
                effects: {
                    wood: { buy: 1.5, sell: 1.8 },
                    stick: { buy: 1.3, sell: 1.5 },
                    wooden_plank: { buy: 1.6, sell: 2.0 }
                }
            },
            {
                id: 'ore_abundance',
                name: 'Ore Abundance',
                icon: '‚õèÔ∏è',
                description: 'New mining techniques have flooded the market with ores',
                duration: 300000,
                effects: {
                    iron_ore: { buy: 0.7, sell: 0.5 },
                    copper_ore: { buy: 0.7, sell: 0.5 },
                    stone: { buy: 0.8, sell: 0.6 }
                }
            },
            {
                id: 'fishing_festival',
                name: 'Fishing Festival',
                icon: 'üé£',
                description: 'The annual fishing festival increases seafood prices',
                duration: 300000,
                effects: {
                    fish: { buy: 1.4, sell: 1.7 },
                    seaweed: { buy: 1.3, sell: 1.5 },
                    pearl: { buy: 1.5, sell: 2.0 }
                }
            },
            {
                id: 'gem_rush',
                name: 'Gem Rush',
                icon: 'üíé',
                description: 'Adventurers are seeking precious gems and crystals',
                duration: 300000,
                effects: {
                    gem: { buy: 1.6, sell: 2.0 },
                    crystal: { buy: 1.5, sell: 1.8 },
                    silver_ore: { buy: 1.3, sell: 1.6 },
                    gold_ore: { buy: 1.4, sell: 1.8 }
                }
            },
            {
                id: 'market_crash',
                name: 'Market Crash',
                icon: 'üìâ',
                description: 'Economic troubles have lowered all prices',
                duration: 300000,
                effects: {
                    // Affects everything
                    '*': { buy: 0.6, sell: 0.5 }
                }
            },
            {
                id: 'trade_boom',
                name: 'Trade Boom',
                icon: 'üìà',
                description: 'Merchants are buying everything at premium prices!',
                duration: 300000,
                effects: {
                    '*': { buy: 1.3, sell: 1.5 }
                }
            }
        ];

        // Worker Types
        const workerTypes = {
            general: {
                name: 'General Worker',
                icon: 'üë∑',
                cost: 500,
                baseUpkeep: 10,
                bonuses: {}
            },
            lumberjack: {
                name: 'Lumberjack',
                icon: 'ü™ì',
                cost: 800,
                baseUpkeep: 15,
                bonuses: {
                    'Gather Wood': 1.3,
                    'Gather Sticks': 1.2
                }
            },
            miner: {
                name: 'Miner',
                icon: '‚õèÔ∏è',
                cost: 800,
                baseUpkeep: 15,
                bonuses: {
                    'Mine Stone': 1.3,
                    'Mine Iron': 1.3,
                    'Mine Coal': 1.3
                }
            },
            fisherman: {
                name: 'Fisherman',
                icon: 'üé£',
                cost: 800,
                baseUpkeep: 15,
                bonuses: {
                    'Fish': 1.3,
                    'Collect Seaweed': 1.2
                }
            },
            gatherer: {
                name: 'Gatherer',
                icon: 'üåæ',
                cost: 700,
                baseUpkeep: 12,
                bonuses: {
                    'Gather Herbs': 1.25,
                    'Gather Berries': 1.25,
                    'Collect Seaweed': 1.2
                }
            },
            craftsman: {
                name: 'Craftsman',
                icon: 'üî®',
                cost: 1000,
                baseUpkeep: 20,
                bonuses: {
                    // Reduces crafting time by 40% (applied differently)
                    crafting: 0.6
                }
            }
        };

        // Worker Traits
        const workerTraits = {
            efficient: {
                name: 'Efficient',
                icon: '‚ö°',
                description: '+20% production speed',
                rarity: 'rare',
                effect: { speed: 1.2 }
            },
            fast_learner: {
                name: 'Fast Learner',
                icon: 'üìö',
                description: '+50% XP gain',
                rarity: 'rare',
                effect: { xp: 1.5 }
            },
            lucky: {
                name: 'Lucky',
                icon: 'üçÄ',
                description: '+15% output',
                rarity: 'rare',
                effect: { output: 1.15 }
            },
            hardworking: {
                name: 'Hardworking',
                icon: 'üí™',
                description: '+10% output, +25% XP',
                rarity: 'uncommon',
                effect: { output: 1.1, xp: 1.25 }
            },
            specialized: {
                name: 'Specialized',
                icon: 'üéØ',
                description: '+30% to assigned task, -10% to others',
                rarity: 'uncommon',
                effect: { specialized: true }
            },
            average: {
                name: 'Average',
                icon: 'üòê',
                description: 'No special traits',
                rarity: 'common',
                effect: {}
            },
            slow: {
                name: 'Slow',
                icon: 'üêå',
                description: '-15% production speed',
                rarity: 'uncommon',
                effect: { speed: 0.85 }
            },
            clumsy: {
                name: 'Clumsy',
                icon: 'ü§ï',
                description: '-10% output',
                rarity: 'common',
                effect: { output: 0.9 }
            },
            lazy: {
                name: 'Lazy',
                icon: 'üò¥',
                description: '-20% XP gain',
                rarity: 'common',
                effect: { xp: 0.8 }
            }
        };

        // Equipment for Workers
        const workerEquipment = {
            basic_gloves: {
                name: 'Basic Gloves',
                icon: 'üß§',
                slot: 'hands',
                bonus: { output: 1.05 },
                durability: 100,
                cost: 50
            },
            leather_gloves: {
                name: 'Leather Gloves',
                icon: 'üß§',
                slot: 'hands',
                bonus: { output: 1.15 },
                durability: 200,
                cost: 150
            },
            work_boots: {
                name: 'Work Boots',
                icon: 'ü•æ',
                slot: 'feet',
                bonus: { speed: 1.1 },
                durability: 150,
                cost: 100
            },
            hardhat: {
                name: 'Hardhat',
                icon: '‚õëÔ∏è',
                slot: 'head',
                bonus: { safety: 1.2 }, // Reduces equipment wear
                durability: 300,
                cost: 200
            }
        };

        // Daily Quest Templates
        const dailyQuestTemplates = [
            // Gathering Quests
            {
                id: 'gather_wood',
                name: 'Lumber Jack',
                icon: 'ü™µ',
                description: 'Gather {amount} wood',
                type: 'gather',
                target: 'wood',
                amounts: [20, 30, 50],
                rewards: { silver: [100, 150, 250], gold: [0, 0, 1] }
            },
            {
                id: 'gather_stone',
                name: 'Stone Mason',
                icon: '‚õèÔ∏è',
                description: 'Collect {amount} stone',
                type: 'gather',
                target: 'stone',
                amounts: [15, 25, 40],
                rewards: { silver: [120, 180, 300], gold: [0, 0, 1] }
            },
            {
                id: 'catch_fish',
                name: 'Master Angler',
                icon: 'üé£',
                description: 'Catch {amount} fish',
                type: 'gather',
                target: 'fish',
                amounts: [15, 25, 35],
                rewards: { silver: [100, 150, 250], gold: [0, 0, 1] }
            },
            
            // Action Quests
            {
                id: 'complete_actions',
                name: 'Busy Day',
                icon: '‚ö°',
                description: 'Complete {amount} actions',
                type: 'actions',
                amounts: [10, 20, 30],
                rewards: { silver: [150, 250, 400], gold: [0, 1, 1] }
            },
            
            // Crafting Quests
            {
                id: 'craft_items',
                name: 'Master Crafter',
                icon: 'üî®',
                description: 'Craft {amount} items',
                type: 'craft',
                amounts: [5, 10, 15],
                rewards: { silver: [200, 350, 500], gold: [0, 1, 2] }
            },
            
            // Trading Quests
            {
                id: 'make_trades',
                name: 'Merchant Prince',
                icon: 'üí∞',
                description: 'Make {amount} trades with NPCs',
                type: 'trade',
                amounts: [5, 10, 20],
                rewards: { silver: [150, 250, 400], gold: [0, 1, 1] }
            },
            
            // Silver Quests
            {
                id: 'earn_silver',
                name: 'Profit Seeker',
                icon: 'ü•à',
                description: 'Earn {amount} Silver',
                type: 'silver_earned',
                amounts: [500, 1000, 2000],
                rewards: { silver: [200, 400, 800], gold: [0, 1, 2] }
            },
            
            // Worker Quests
            {
                id: 'worker_production',
                name: 'Workforce',
                icon: 'üë∑',
                description: 'Have workers produce {amount} items',
                type: 'worker_items',
                amounts: [20, 40, 60],
                rewards: { silver: [150, 300, 500], gold: [0, 1, 2] }
            }
        ];

        // Achievement Definitions
        const achievements = {
            // Gathering Achievements
            first_wood: {
                id: 'first_wood',
                name: 'First Steps',
                icon: 'ü™µ',
                description: 'Gather your first piece of wood',
                category: 'gathering',
                tier: 'bronze',
                requirement: { type: 'total_gathered', item: 'wood', amount: 1 },
                reward: { silver: 50 }
            },
            wood_gatherer: {
                id: 'wood_gatherer',
                name: 'Wood Gatherer',
                icon: 'ü™µ',
                description: 'Gather 100 wood',
                category: 'gathering',
                tier: 'silver',
                requirement: { type: 'total_gathered', item: 'wood', amount: 100 },
                reward: { silver: 200, gold: 1 }
            },
            lumber_lord: {
                id: 'lumber_lord',
                name: 'Lumber Lord',
                icon: 'ü™µ',
                description: 'Gather 1,000 wood',
                category: 'gathering',
                tier: 'gold',
                requirement: { type: 'total_gathered', item: 'wood', amount: 1000 },
                reward: { silver: 1000, gold: 3 }
            },
            
            stone_collector: {
                id: 'stone_collector',
                name: 'Stone Collector',
                icon: '‚õèÔ∏è',
                description: 'Gather 100 stone',
                category: 'gathering',
                tier: 'silver',
                requirement: { type: 'total_gathered', item: 'stone', amount: 100 },
                reward: { silver: 200, gold: 1 }
            },
            
            fisherman_ace: {
                id: 'fisherman_ace',
                name: 'Ace Fisherman',
                icon: 'üé£',
                description: 'Catch 100 fish',
                category: 'gathering',
                tier: 'silver',
                requirement: { type: 'total_gathered', item: 'fish', amount: 100 },
                reward: { silver: 200, gold: 1 }
            },
            
            // Action Achievements
            action_novice: {
                id: 'action_novice',
                name: 'Action Novice',
                icon: '‚ö°',
                description: 'Complete 50 actions',
                category: 'progression',
                tier: 'bronze',
                requirement: { type: 'stat', stat: 'actionsComplete', amount: 50 },
                reward: { silver: 250 }
            },
            action_veteran: {
                id: 'action_veteran',
                name: 'Action Veteran',
                icon: '‚ö°',
                description: 'Complete 500 actions',
                category: 'progression',
                tier: 'silver',
                requirement: { type: 'stat', stat: 'actionsComplete', amount: 500 },
                reward: { silver: 1000, gold: 2 }
            },
            action_master: {
                id: 'action_master',
                name: 'Action Master',
                icon: '‚ö°',
                description: 'Complete 2,000 actions',
                category: 'progression',
                tier: 'gold',
                requirement: { type: 'stat', stat: 'actionsComplete', amount: 2000 },
                reward: { silver: 5000, gold: 5 }
            },
            
            // Crafting Achievements
            first_craft: {
                id: 'first_craft',
                name: 'First Craft',
                icon: 'üî®',
                description: 'Craft your first item',
                category: 'progression',
                tier: 'bronze',
                requirement: { type: 'stat', stat: 'itemsCrafted', amount: 1 },
                reward: { silver: 100 }
            },
            master_crafter: {
                id: 'master_crafter',
                name: 'Master Crafter',
                icon: 'üî®',
                description: 'Craft 100 items',
                category: 'progression',
                tier: 'silver',
                requirement: { type: 'stat', stat: 'itemsCrafted', amount: 100 },
                reward: { silver: 500, gold: 2 }
            },
            legendary_artisan: {
                id: 'legendary_artisan',
                name: 'Legendary Artisan',
                icon: 'üî®',
                description: 'Craft 500 items',
                category: 'progression',
                tier: 'gold',
                requirement: { type: 'stat', stat: 'itemsCrafted', amount: 500 },
                reward: { silver: 3000, gold: 5 }
            },
            
            // Economy Achievements
            first_trade: {
                id: 'first_trade',
                name: 'First Trade',
                icon: 'üí∞',
                description: 'Make your first NPC trade',
                category: 'economy',
                tier: 'bronze',
                requirement: { type: 'stat', stat: 'tradesMade', amount: 1 },
                reward: { silver: 50 }
            },
            merchant: {
                id: 'merchant',
                name: 'Merchant',
                icon: 'üí∞',
                description: 'Make 50 trades',
                category: 'economy',
                tier: 'silver',
                requirement: { type: 'stat', stat: 'tradesMade', amount: 50 },
                reward: { silver: 300, gold: 1 }
            },
            tycoon: {
                id: 'tycoon',
                name: 'Business Tycoon',
                icon: 'üí∞',
                description: 'Make 200 trades',
                category: 'economy',
                tier: 'gold',
                requirement: { type: 'stat', stat: 'tradesMade', amount: 200 },
                reward: { silver: 2000, gold: 4 }
            },
            
            silver_hoarder: {
                id: 'silver_hoarder',
                name: 'Silver Hoarder',
                icon: 'ü•à',
                description: 'Accumulate 10,000 Silver at once',
                category: 'economy',
                tier: 'silver',
                requirement: { type: 'silver_held', amount: 10000 },
                reward: { silver: 1000, gold: 2 }
            },
            wealthy: {
                id: 'wealthy',
                name: 'Wealthy Magnate',
                icon: 'ü•à',
                description: 'Accumulate 50,000 Silver at once',
                category: 'economy',
                tier: 'gold',
                requirement: { type: 'silver_held', amount: 50000 },
                reward: { silver: 5000, gold: 10 }
            },
            
            profit_maker: {
                id: 'profit_maker',
                name: 'Profit Maker',
                icon: 'üìà',
                description: 'Earn 5,000 total Silver',
                category: 'economy',
                tier: 'silver',
                requirement: { type: 'stat', stat: 'silverEarned', amount: 5000 },
                reward: { silver: 500, gold: 1 }
            },
            
            // Worker Achievements
            first_worker: {
                id: 'first_worker',
                name: 'First Hire',
                icon: 'üë∑',
                description: 'Hire your first worker',
                category: 'progression',
                tier: 'bronze',
                requirement: { type: 'workers', amount: 1 },
                reward: { silver: 100 }
            },
            worker_boss: {
                id: 'worker_boss',
                name: 'Worker Boss',
                icon: 'üë∑',
                description: 'Have 3 workers at once',
                category: 'progression',
                tier: 'silver',
                requirement: { type: 'workers', amount: 3 },
                reward: { silver: 500, gold: 1 }
            },
            
            // Biome Achievements
            explorer: {
                id: 'explorer',
                name: 'Explorer',
                icon: 'üó∫Ô∏è',
                description: 'Unlock all biomes',
                category: 'progression',
                tier: 'gold',
                requirement: { type: 'biomes_unlocked', amount: 4 },
                reward: { silver: 2000, gold: 5 }
            },
            
            // Tool Achievements
            well_equipped: {
                id: 'well_equipped',
                name: 'Well Equipped',
                icon: '‚öíÔ∏è',
                description: 'Own 5 different tools',
                category: 'progression',
                tier: 'silver',
                requirement: { type: 'tools_owned', amount: 5 },
                reward: { silver: 400, gold: 1 }
            }
        };

        // Premium Shop Items
        const shopItems = {
            // Boosts (Temporary)
            speed_boost_1h: {
                id: 'speed_boost_1h',
                name: '1-Hour Speed Boost',
                icon: '‚ö°',
                description: 'All actions 25% faster for 1 hour',
                category: 'boosts',
                cost: 2,
                consumable: true,
                duration: 3600000, // 1 hour
                effect: { actionSpeed: 1.25 }
            },
            speed_boost_4h: {
                id: 'speed_boost_4h',
                name: '4-Hour Speed Boost',
                icon: '‚ö°',
                description: 'All actions 25% faster for 4 hours',
                category: 'boosts',
                cost: 6,
                consumable: true,
                duration: 14400000, // 4 hours
                effect: { actionSpeed: 1.25 }
            },
            output_boost_1h: {
                id: 'output_boost_1h',
                name: '1-Hour Output Boost',
                icon: 'üìà',
                description: 'All production +30% for 1 hour',
                category: 'boosts',
                cost: 3,
                consumable: true,
                duration: 3600000,
                effect: { outputBoost: 1.30 }
            },
            output_boost_4h: {
                id: 'output_boost_4h',
                name: '4-Hour Output Boost',
                icon: 'üìà',
                description: 'All production +30% for 4 hours',
                category: 'boosts',
                cost: 8,
                consumable: true,
                duration: 14400000,
                effect: { outputBoost: 1.30 }
            },
            xp_boost_1h: {
                id: 'xp_boost_1h',
                name: '1-Hour XP Boost',
                icon: '‚≠ê',
                description: 'Worker XP gain +50% for 1 hour',
                category: 'boosts',
                cost: 2,
                consumable: true,
                duration: 3600000,
                effect: { xpBoost: 1.50 }
            },
            
            // Instant Actions
            instant_complete_5: {
                id: 'instant_complete_5',
                name: '5x Instant Complete',
                icon: '‚è±Ô∏è',
                description: 'Instantly complete any 5 actions',
                category: 'convenience',
                cost: 3,
                consumable: true,
                charges: 5,
                effect: { instantComplete: true }
            },
            instant_complete_20: {
                id: 'instant_complete_20',
                name: '20x Instant Complete',
                icon: '‚è±Ô∏è',
                description: 'Instantly complete any 20 actions',
                category: 'convenience',
                cost: 10,
                consumable: true,
                charges: 20,
                effect: { instantComplete: true }
            },
            
            // Market Fee Reduction
            market_fee_reduction: {
                id: 'market_fee_reduction',
                name: 'Market Fee Reduction',
                icon: 'üí∞',
                description: 'Reduce market fees from 3% to 1% (permanent)',
                category: 'convenience',
                cost: 15,
                permanent: true,
                effect: { marketFeeReduction: 0.01 }
            },
            
            // Auto-Collect
            auto_collect: {
                id: 'auto_collect',
                name: 'Auto-Collect',
                icon: 'ü§ñ',
                description: 'Automatically collect completed actions (permanent)',
                category: 'convenience',
                cost: 20,
                permanent: true,
                effect: { autoCollect: true }
            },
            
            // Worker Slots
            worker_slot_4: {
                id: 'worker_slot_4',
                name: '4th Worker Slot',
                icon: 'üë∑',
                description: 'Unlock ability to hire a 4th worker',
                category: 'expansion',
                cost: 10,
                permanent: true,
                effect: { workerSlots: 1 }
            },
            worker_slot_5: {
                id: 'worker_slot_5',
                name: '5th Worker Slot',
                icon: 'üë∑',
                description: 'Unlock ability to hire a 5th worker (requires 4th)',
                category: 'expansion',
                cost: 20,
                permanent: true,
                requires: 'worker_slot_4',
                effect: { workerSlots: 1 }
            },
            worker_slot_6: {
                id: 'worker_slot_6',
                name: '6th Worker Slot',
                icon: 'üë∑',
                description: 'Unlock ability to hire a 6th worker (requires 5th)',
                category: 'expansion',
                cost: 35,
                permanent: true,
                requires: 'worker_slot_5',
                effect: { workerSlots: 1 }
            },
            
            // Inventory Expansion
            inventory_expansion: {
                id: 'inventory_expansion',
                name: 'Inventory Expansion',
                icon: 'üì¶',
                description: 'No inventory limits (permanent)',
                category: 'expansion',
                cost: 25,
                permanent: true,
                effect: { unlimitedInventory: true }
            },
            
            // Cosmetics
            custom_name_color: {
                id: 'custom_name_color',
                name: 'Gold Name Color',
                icon: '‚ú®',
                description: 'Display your name in gold (cosmetic)',
                category: 'cosmetic',
                cost: 5,
                permanent: true,
                effect: { nameColor: '#FFD700' }
            },
            premium_badge: {
                id: 'premium_badge',
                name: 'Premium Badge',
                icon: 'üëë',
                description: 'Show premium badge next to your name',
                category: 'cosmetic',
                cost: 8,
                permanent: true,
                effect: { premiumBadge: true }
            },
            custom_theme: {
                id: 'custom_theme',
                name: 'Custom UI Theme',
                icon: 'üé®',
                description: 'Unlock additional UI color themes',
                category: 'cosmetic',
                cost: 12,
                permanent: true,
                effect: { customThemes: true }
            },
            
            // Tool Repair Discount
            tool_repair_discount: {
                id: 'tool_repair_discount',
                name: 'Tool Repair Discount',
                icon: 'üîß',
                description: '50% off all tool repairs (permanent)',
                category: 'convenience',
                cost: 15,
                permanent: true,
                effect: { repairDiscount: 0.5 }
            },
            
            // Daily Quest Reroll
            quest_reroll: {
                id: 'quest_reroll',
                name: 'Daily Quest Reroll',
                icon: 'üé≤',
                description: 'Reroll one daily quest (single use)',
                category: 'convenience',
                cost: 1,
                consumable: true,
                effect: { questReroll: true }
            }
        };

        // Initialize Game
        function initGame() {
            loadGame();
            initAudioSystem();
            initializeEconomy();
            initializeQuests();
            renderBiomeActions();
            renderCraftingRecipes();
            renderTools();
            updateUI();
            renderWorkers();
            renderMarket();
            updateBiomeSelector();
            renderNPCTraders();
            renderPriceHistory();
            checkMarketEvent();
            renderDailyQuests();
            renderAchievements();
            renderShop();
            renderCharacter();
            renderWalletStatus();
            renderGoldStore();
            
            // Setup navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchScreen(e.target.dataset.screen);
                });
            });

            // Auto-save every 30 seconds
            setInterval(() => {
                saveGame(true);
            }, 30000);

            // Update worker production
            setInterval(() => {
                updateWorkers();
            }, 1000);
            
            // Check tool durability
            setInterval(() => {
                checkToolDurability();
            }, 5000);
            
            // Update economy
            setInterval(() => {
                updateEconomy();
            }, 60000); // Every minute
            
            // Check taxes
            setInterval(() => {
                checkTaxes();
            }, 1000);
            
            // Check quests and achievements
            setInterval(() => {
                checkAchievements();
                updateQuestTimers();
            }, 1000);
            
            // Update boosts
            setInterval(() => {
                updateActiveBoosts();
            }, 1000);
            
            // Update character display
            setInterval(() => {
                renderCharacter();
            }, 30000); // Every 30 seconds to update play time
        }
        
        function initializeQuests() {
            // Initialize achievements if not present
            for (const [key, achievement] of Object.entries(achievements)) {
                if (!gameState.achievements[key]) {
                    gameState.achievements[key] = {
                        unlocked: false,
                        progress: 0,
                        dateUnlocked: null
                    };
                }
            }
            
            // Check if daily quests need reset (24 hours = 86400000ms, using 30 minutes for demo: 1800000)
            const questResetTime = 1800000; // 30 minutes for demo
            const timeSinceReset = Date.now() - (gameState.quests.lastDailyReset || 0);
            
            if (timeSinceReset >= questResetTime || gameState.quests.daily.length === 0) {
                generateDailyQuests();
            }
        }
        
        function generateDailyQuests() {
            gameState.quests.daily = [];
            gameState.quests.completedToday = [];
            gameState.quests.lastDailyReset = Date.now();
            
            // Select 3 random quest templates
            const shuffled = [...dailyQuestTemplates].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, 3);
            
            selected.forEach(template => {
                // Random difficulty (0 = easy, 1 = medium, 2 = hard)
                const difficulty = Math.floor(Math.random() * 3);
                const amount = template.amounts[difficulty];
                
                const quest = {
                    id: `${template.id}_${Date.now()}_${Math.random()}`,
                    templateId: template.id,
                    name: template.name,
                    icon: template.icon,
                    description: template.description.replace('{amount}', amount),
                    type: template.type,
                    target: template.target,
                    amount: amount,
                    progress: 0,
                    completed: false,
                    difficulty: difficulty,
                    reward: {
                        silver: template.rewards.silver[difficulty],
                        gold: template.rewards.gold[difficulty]
                    }
                };
                
                gameState.quests.daily.push(quest);
            });
            
            showNotification('Daily quests refreshed!', 'success');
            addActivity('New daily quests available!');
        }
        
        function renderDailyQuests() {
            const container = document.getElementById('dailyQuests');
            
            if (gameState.quests.daily.length === 0) {
                container.innerHTML = '<p class="card-description">No daily quests available. Check back soon!</p>';
                return;
            }
            
            container.innerHTML = gameState.quests.daily.map(quest => {
                const progress = Math.min(quest.progress, quest.amount);
                const progressPercent = (progress / quest.amount) * 100;
                const difficultyLabels = ['Easy', 'Medium', 'Hard'];
                const difficultyColors = ['var(--accent-green)', 'var(--accent-blue)', 'var(--accent-red)'];
                
                return `
                    <div class="card ${quest.completed ? 'action-active' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h3 class="card-title">${quest.icon} ${quest.name}</h3>
                            <div style="padding: 4px 10px; background: var(--bg-primary); border: 1px solid ${difficultyColors[quest.difficulty]}; border-radius: 6px; font-size: 0.75rem; font-weight: 700; color: ${difficultyColors[quest.difficulty]};">
                                ${difficultyLabels[quest.difficulty]}
                            </div>
                        </div>
                        <p class="card-description">${quest.description}</p>
                        
                        <div class="progress-container" style="margin: 15px 0;">
                            <div class="progress-label">
                                <span>Progress</span>
                                <span>${progress} / ${quest.amount}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Reward:</div>
                                <div style="font-size: 1.1rem; font-weight: 700;">
                                    ${quest.reward.silver} ü•à ${quest.reward.gold > 0 ? `+ ${quest.reward.gold} ü•á` : ''}
                                </div>
                            </div>
                            <button class="btn ${quest.completed ? 'btn-primary' : 'btn-secondary'}" 
                                    onclick="claimQuest('${quest.id}')" 
                                    ${!quest.completed || gameState.quests.completedToday.includes(quest.id) ? 'disabled' : ''}>
                                ${gameState.quests.completedToday.includes(quest.id) ? 'Claimed ‚úì' : quest.completed ? 'Claim Reward' : 'In Progress'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        let currentAchievementFilter = 'all';
        
        function renderAchievements() {
            const container = document.getElementById('achievements');
            const achievementsList = Object.values(achievements);
            
            // Apply filter
            const filtered = achievementsList.filter(achievement => {
                if (currentAchievementFilter === 'all') return true;
                if (currentAchievementFilter === 'unlocked') return gameState.achievements[achievement.id]?.unlocked;
                if (currentAchievementFilter === 'locked') return !gameState.achievements[achievement.id]?.unlocked;
                return achievement.category === currentAchievementFilter;
            });
            
            // Update count
            const unlockedCount = achievementsList.filter(a => gameState.achievements[a.id]?.unlocked).length;
            document.getElementById('achievementsUnlocked').textContent = unlockedCount;
            document.getElementById('totalAchievements').textContent = achievementsList.length;
            
            const tierColors = {
                bronze: '#CD7F32',
                silver: '#C0C0C0',
                gold: '#FFD700'
            };
            
            const tierLabels = {
                bronze: 'Bronze',
                silver: 'Silver',
                gold: 'Gold'
            };
            
            container.innerHTML = filtered.map(achievement => {
                const state = gameState.achievements[achievement.id] || { unlocked: false, progress: 0 };
                const progress = calculateAchievementProgress(achievement);
                const progressPercent = (progress / achievement.requirement.amount) * 100;
                
                return `
                    <div class="card ${state.unlocked ? 'action-active' : ''}" style="${!state.unlocked ? 'opacity: 0.7;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h3 class="card-title">${achievement.icon} ${achievement.name}</h3>
                            <div style="padding: 4px 10px; background: ${tierColors[achievement.tier]}20; border: 1px solid ${tierColors[achievement.tier]}; border-radius: 6px; font-size: 0.75rem; font-weight: 700; color: ${tierColors[achievement.tier]};">
                                ${tierLabels[achievement.tier]}
                            </div>
                        </div>
                        <p class="card-description">${achievement.description}</p>
                        
                        ${!state.unlocked ? `
                            <div class="progress-container" style="margin: 15px 0;">
                                <div class="progress-label">
                                    <span>Progress</span>
                                    <span>${Math.min(progress, achievement.requirement.amount)} / ${achievement.requirement.amount}</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${Math.min(progressPercent, 100)}%"></div>
                                </div>
                            </div>
                        ` : `
                            <div style="padding: 10px; background: rgba(42, 157, 143, 0.2); border: 1px solid var(--accent-green); border-radius: 6px; margin: 15px 0; text-align: center; font-weight: 700; color: var(--accent-green);">
                                ‚úì UNLOCKED ${state.dateUnlocked ? `on ${new Date(state.dateUnlocked).toLocaleDateString()}` : ''}
                            </div>
                        `}
                        
                        <div style="padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">Reward:</div>
                            <div style="font-size: 1.1rem; font-weight: 700;">
                                ${achievement.reward.silver} ü•à ${achievement.reward.gold ? `+ ${achievement.reward.gold} ü•á` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterAchievements(filter) {
            currentAchievementFilter = filter;
            
            // Update button styles
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.style.background = 'var(--bg-primary)';
                btn.style.borderColor = 'var(--border-color)';
            });
            
            const activeBtn = document.getElementById(`filter-${filter}`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--accent-blue)';
                activeBtn.style.borderColor = 'var(--accent-blue)';
            }
            
            renderAchievements();
        }
        
        function checkQuestProgress(type, target, amount) {
            gameState.quests.daily.forEach(quest => {
                if (quest.completed || gameState.quests.completedToday.includes(quest.id)) return;
                
                if (quest.type === type) {
                    if (type === 'gather' && quest.target === target) {
                        quest.progress = Math.min(quest.progress + amount, quest.amount);
                    } else if (type === 'actions') {
                        quest.progress++;
                    } else if (type === 'craft') {
                        quest.progress++;
                    } else if (type === 'trade') {
                        quest.progress++;
                    } else if (type === 'silver_earned') {
                        quest.progress += amount;
                    } else if (type === 'worker_items') {
                        quest.progress += amount;
                    }
                    
                    if (quest.progress >= quest.amount) {
                        quest.completed = true;
                        showNotification(`Quest complete: ${quest.name}!`, 'success');
                        addActivity(`Completed quest: ${quest.name}`);
                    }
                }
            });
            
            renderDailyQuests();
        }
        
        function claimQuest(questId) {
            const quest = gameState.quests.daily.find(q => q.id === questId);
            if (!quest || !quest.completed || gameState.quests.completedToday.includes(questId)) return;
            
            gameState.silver += quest.reward.silver;
            gameState.gold += quest.reward.gold;
            gameState.quests.completedToday.push(questId);
            
            showNotification(`Claimed: ${quest.reward.silver} Silver ${quest.reward.gold > 0 ? `+ ${quest.reward.gold} Gold` : ''}`, 'success');
            addActivity(`Claimed quest reward: ${quest.name}`);
            
            renderDailyQuests();
            updateUI();
        }
        
        function calculateAchievementProgress(achievement) {
            const req = achievement.requirement;
            
            switch (req.type) {
                case 'total_gathered':
                    return gameState.inventory[req.item] || 0;
                case 'stat':
                    return gameState.stats[req.stat] || 0;
                case 'silver_held':
                    return gameState.silver;
                case 'workers':
                    return gameState.workers.length;
                case 'biomes_unlocked':
                    return gameState.progress.unlockedBiomes.length;
                case 'tools_owned':
                    return Object.keys(gameState.tools).length;
                default:
                    return 0;
            }
        }
        
        function checkAchievements() {
            let anyUnlocked = false;
            
            for (const [key, achievement] of Object.entries(achievements)) {
                const state = gameState.achievements[key];
                if (state.unlocked) continue;
                
                const progress = calculateAchievementProgress(achievement);
                state.progress = progress;
                
                if (progress >= achievement.requirement.amount) {
                    state.unlocked = true;
                    state.dateUnlocked = Date.now();
                    anyUnlocked = true;
                    
                    // Award rewards
                    gameState.silver += achievement.reward.silver;
                    if (achievement.reward.gold) {
                        gameState.gold += achievement.reward.gold;
                    }
                    
                    showNotification(`üèÜ Achievement Unlocked: ${achievement.name}!`, 'success');
                    playSound('achievement');
                    addActivity(`Unlocked achievement: ${achievement.name}`);
                }
            }
            
            if (anyUnlocked) {
                renderAchievements();
                updateUI();
            }
        }
        
        function updateQuestTimers() {
            const questResetTime = 1800000; // 30 minutes
            const timeSinceReset = Date.now() - (gameState.quests.lastDailyReset || Date.now());
            const timeUntilReset = questResetTime - timeSinceReset;
            
            const hours = Math.floor(timeUntilReset / 3600000);
            const minutes = Math.floor((timeUntilReset % 3600000) / 60000);
            const seconds = Math.floor((timeUntilReset % 60000) / 1000);
            
            const timerEl = document.getElementById('questResetTimer');
            if (timerEl) {
                timerEl.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Auto-reset if time is up
            if (timeUntilReset <= 0) {
                generateDailyQuests();
                renderDailyQuests();
            }
        }
        
        // Shop Functions
        let currentShopFilter = 'all';
        
        function renderShop() {
            const container = document.getElementById('shopItems');
            const items = Object.values(shopItems);
            
            // Apply filter
            const filtered = items.filter(item => {
                if (currentShopFilter === 'all') return true;
                return item.category === currentShopFilter;
            });
            
            // Update gold balance
            const goldBalanceEl = document.getElementById('shopGoldBalance');
            if (goldBalanceEl) goldBalanceEl.textContent = gameState.gold;
            
            container.innerHTML = filtered.map(item => {
                const isPurchased = gameState.shop.purchased.includes(item.id);
                const canPurchase = gameState.gold >= item.cost;
                const hasRequirement = !item.requires || gameState.shop.purchased.includes(item.requires);
                
                let buttonText = 'Purchase';
                let buttonDisabled = !canPurchase || !hasRequirement;
                
                if (item.permanent && isPurchased) {
                    buttonText = 'Owned ‚úì';
                    buttonDisabled = true;
                } else if (item.consumable) {
                    const charges = getItemCharges(item.id);
                    if (charges > 0) {
                        buttonText = `Use (${charges} left)`;
                        buttonDisabled = false;
                    }
                }
                
                if (!hasRequirement) {
                    buttonText = 'Requires Previous';
                }
                
                return `
                    <div class="card ${isPurchased && item.permanent ? 'action-active' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h3 class="card-title">${item.icon} ${item.name}</h3>
                            <div style="padding: 4px 10px; background: var(--bg-primary); border: 1px solid var(--accent-gold); border-radius: 6px; font-size: 0.9rem; font-weight: 700; color: var(--accent-gold);">
                                ${item.cost} ü•á
                            </div>
                        </div>
                        <p class="card-description">${item.description}</p>
                        
                        <div style="margin: 15px 0; padding: 15px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px;">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">Type:</div>
                            <div style="font-size: 0.9rem; font-weight: 700;">
                                ${item.permanent ? 'üîí Permanent' : item.consumable ? 'üì¶ Consumable' : '‚è±Ô∏è Temporary'}
                            </div>
                            ${item.duration ? `
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
                                    Duration: ${formatDuration(item.duration)}
                                </div>
                            ` : ''}
                            ${item.charges ? `
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
                                    Charges: ${item.charges}
                                </div>
                            ` : ''}
                        </div>
                        
                        ${!hasRequirement ? `
                            <div style="padding: 10px; background: rgba(231, 111, 81, 0.2); border: 1px solid var(--accent-red); border-radius: 6px; margin-bottom: 10px; font-size: 0.85rem; color: var(--accent-red);">
                                ‚ö†Ô∏è Requires: ${shopItems[item.requires]?.name}
                            </div>
                        ` : ''}
                        
                        <button class="btn ${isPurchased && item.permanent ? 'btn-secondary' : 'btn-primary'}" 
                                onclick="purchaseItem('${item.id}')" 
                                ${buttonDisabled ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
            
            // Render active boosts
            renderActiveBoosts();
        }
        
        function filterShop(category) {
            currentShopFilter = category;
            
            // Update button styles
            document.querySelectorAll('[id^="shop-filter-"]').forEach(btn => {
                btn.style.background = 'var(--bg-primary)';
                btn.style.borderColor = 'var(--border-color)';
            });
            
            const activeBtn = document.getElementById(`shop-filter-${category}`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--accent-blue)';
                activeBtn.style.borderColor = 'var(--accent-blue)';
            }
            
            renderShop();
        }
        
        function purchaseItem(itemId) {
            const item = shopItems[itemId];
            if (!item) return;
            
            // Check if it's a use (consumable with charges)
            const charges = getItemCharges(itemId);
            if (item.consumable && charges > 0) {
                useConsumable(itemId);
                return;
            }
            
            // Check if can afford
            if (gameState.gold < item.cost) {
                showNotification('Not enough Gold!', 'error');
                playSound('error');
                return;
            }
            
            // Check requirements
            if (item.requires && !gameState.shop.purchased.includes(item.requires)) {
                showNotification(`Requires ${shopItems[item.requires].name} first!`, 'error');
                playSound('error');
                return;
            }
            
            // Check if already owned (permanent)
            if (item.permanent && gameState.shop.purchased.includes(itemId)) {
                showNotification('Already owned!', 'error');
                playSound('error');
                return;
            }
            
            // Purchase
            gameState.gold -= item.cost;
            playSound('purchase');
            
            if (item.permanent) {
                gameState.shop.purchased.push(itemId);
                showNotification(`Purchased: ${item.name}!`, 'success');
                addActivity(`Purchased ${item.name} for ${item.cost} Gold`);
            } else if (item.consumable) {
                // Add charges
                if (!gameState.shop.purchased.includes(itemId)) {
                    gameState.shop.purchased.push(itemId);
                }
                addCharges(itemId, item.charges || 1);
                showNotification(`Purchased: ${item.name} (${item.charges} charges)`, 'success');
                addActivity(`Purchased ${item.name} for ${item.cost} Gold`);
            } else if (item.duration) {
                // Activate timed boost
                activateBoost(itemId);
                showNotification(`Activated: ${item.name}!`, 'success');
                addActivity(`Activated ${item.name} for ${item.cost} Gold`);
            }
            
            renderShop();
            updateUI();
        }
        
        function activateBoost(itemId) {
            const item = shopItems[itemId];
            if (!item || !item.duration) return;
            
            gameState.shop.activeBoosts[itemId] = {
                endTime: Date.now() + item.duration,
                effect: item.effect
            };
        }
        
        function useConsumable(itemId) {
            const item = shopItems[itemId];
            if (!item || !item.consumable) return;
            
            const charges = getItemCharges(itemId);
            if (charges <= 0) {
                showNotification('No charges remaining!', 'error');
                return;
            }
            
            if (item.effect.instantComplete) {
                // Check if any actions are active
                const activeActionIds = Object.keys(gameState.activeActions);
                if (activeActionIds.length === 0) {
                    showNotification('No actions in progress!', 'error');
                    return;
                }
                
                // Complete the first active action
                const firstActionId = activeActionIds[0];
                completeAction(firstActionId);
                
                addCharges(itemId, -1);
                showNotification('Action instantly completed!', 'success');
            } else if (item.effect.questReroll) {
                // Reroll a random incomplete quest
                const incompleteQuests = gameState.quests.daily.filter(q => !q.completed);
                if (incompleteQuests.length === 0) {
                    showNotification('All quests already complete!', 'error');
                    return;
                }
                
                const questToReroll = incompleteQuests[Math.floor(Math.random() * incompleteQuests.length)];
                const template = dailyQuestTemplates.find(t => t.id === questToReroll.templateId);
                
                if (template) {
                    const difficulty = Math.floor(Math.random() * 3);
                    questToReroll.amount = template.amounts[difficulty];
                    questToReroll.difficulty = difficulty;
                    questToReroll.reward = {
                        silver: template.rewards.silver[difficulty],
                        gold: template.rewards.gold[difficulty]
                    };
                    questToReroll.description = template.description.replace('{amount}', questToReroll.amount);
                    questToReroll.progress = 0;
                }
                
                addCharges(itemId, -1);
                showNotification('Quest rerolled!', 'success');
                renderDailyQuests();
            }
            
            renderShop();
        }
        
        function getItemCharges(itemId) {
            if (!gameState.shop.charges) gameState.shop.charges = {};
            return gameState.shop.charges[itemId] || 0;
        }
        
        function addCharges(itemId, amount) {
            if (!gameState.shop.charges) gameState.shop.charges = {};
            gameState.shop.charges[itemId] = (gameState.shop.charges[itemId] || 0) + amount;
            if (gameState.shop.charges[itemId] < 0) gameState.shop.charges[itemId] = 0;
        }
        
        function renderActiveBoosts() {
            const container = document.getElementById('activeBoosts');
            const activeBoosts = Object.entries(gameState.shop.activeBoosts).filter(([id, boost]) => boost.endTime > Date.now());
            
            if (activeBoosts.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div style="padding: 20px; background: linear-gradient(135deg, rgba(42, 157, 143, 0.2), rgba(69, 123, 157, 0.2)); border: 2px solid var(--accent-green); border-radius: 10px;">
                    <h3 class="card-title" style="margin-bottom: 15px;">‚ö° Active Boosts</h3>
                    <div style="display: grid; gap: 10px;">
                        ${activeBoosts.map(([id, boost]) => {
                            const item = shopItems[id];
                            const timeLeft = boost.endTime - Date.now();
                            const minutes = Math.floor(timeLeft / 60000);
                            const seconds = Math.floor((timeLeft % 60000) / 1000);
                            
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-primary); border: 1px solid var(--accent-green); border-radius: 6px;">
                                    <div>
                                        <div style="font-weight: 700;">${item.icon} ${item.name}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${item.description}</div>
                                    </div>
                                    <div style="font-size: 0.9rem; font-weight: 700; color: var(--accent-gold);">
                                        ${minutes}:${seconds.toString().padStart(2, '0')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function updateActiveBoosts() {
            // Remove expired boosts
            for (const [id, boost] of Object.entries(gameState.shop.activeBoosts)) {
                if (boost.endTime <= Date.now()) {
                    delete gameState.shop.activeBoosts[id];
                    showNotification(`Boost expired: ${shopItems[id].name}`, 'success');
                }
            }
            
            renderActiveBoosts();
        }
        
        function hasActiveBoost(effectType) {
            for (const boost of Object.values(gameState.shop.activeBoosts)) {
                if (boost.endTime > Date.now() && boost.effect[effectType]) {
                    return boost.effect[effectType];
                }
            }
            return null;
        }
        
        function hasPermanentUpgrade(itemId) {
            return gameState.shop.purchased.includes(itemId);
        }
        
        function getMaxWorkerSlots() {
            let base = 3 + Math.floor(gameState.island.level / 2);
            if (hasPermanentUpgrade('worker_slot_4')) base++;
            if (hasPermanentUpgrade('worker_slot_5')) base++;
            if (hasPermanentUpgrade('worker_slot_6')) base++;
            return base;
        }
        
        function exchangeSilverForGold() {
            const silverInput = document.getElementById('silverToExchange');
            const silverAmount = parseInt(silverInput.value) || 0;
            
            if (silverAmount < 100) {
                showNotification('Minimum exchange: 100 Silver', 'error');
                return;
            }
            
            if (gameState.silver < silverAmount) {
                showNotification('Not enough Silver!', 'error');
                return;
            }
            
            const goldAmount = Math.floor(silverAmount / 1000);
            
            if (goldAmount < 1) {
                showNotification('Minimum exchange: 1000 Silver = 1 Gold', 'error');
                return;
            }
            
            gameState.silver -= silverAmount;
            gameState.gold += goldAmount;
            gameState.stats.silverSpent = (gameState.stats.silverSpent || 0) + silverAmount;
            
            showNotification(`Exchanged ${silverAmount} Silver for ${goldAmount} Gold!`, 'success');
            addActivity(`Exchanged ${silverAmount} Silver for ${goldAmount} Gold`);
            
            renderShop();
            updateUI();
        }
        
        function formatDuration(ms) {
            const hours = Math.floor(ms / 3600000);
            if (hours >= 1) return `${hours} hour${hours > 1 ? 's' : ''}`;
            const minutes = Math.floor(ms / 60000);
            return `${minutes} minute${minutes > 1 ? 's' : ''}`;
        }
        
        // Update silver to gold display
        document.addEventListener('DOMContentLoaded', () => {
            const silverInput = document.getElementById('silverToExchange');
            if (silverInput) {
                silverInput.addEventListener('input', () => {
                    const silverAmount = parseInt(silverInput.value) || 0;
                    const goldAmount = Math.floor(silverAmount / 1000);
                    const goldDisplay = document.getElementById('goldToReceive');
                    if (goldDisplay) goldDisplay.textContent = goldAmount;
                });
            }
        });
        
        // Character & Inventory Functions
        const inventoryCategories = {
            tier1: ['wood', 'stick', 'berries', 'herbs'],
            tier2: ['stone', 'iron_ore', 'copper_ore', 'coal', 'fish', 'seaweed', 'pearl'],
            tier3: ['silver_ore', 'gold_ore', 'gem', 'crystal'],
            crafted: ['wooden_plank', 'iron_bar', 'copper_bar', 'silver_bar', 'gold_bar', 'rope', 'cloth']
        };
        
        const itemIcons = {
            wood: 'ü™µ',
            stick: 'ü¶¥',
            berries: 'ü´ê',
            herbs: 'üåø',
            stone: 'ü™®',
            iron_ore: '‚öôÔ∏è',
            copper_ore: 'üü†',
            coal: '‚ö´',
            fish: 'üêü',
            seaweed: 'üåä',
            pearl: 'ü¶™',
            silver_ore: '‚ö™',
            gold_ore: 'üü°',
            gem: 'üíé',
            crystal: 'üîÆ',
            wooden_plank: 'ü™µ',
            iron_bar: '‚öôÔ∏è',
            copper_bar: 'üü†',
            silver_bar: '‚ö™',
            gold_bar: 'üü°',
            rope: 'ü™¢',
            cloth: 'üßµ'
        };
        
        const avatarOptions = [
            'üë§', 'üë®', 'üë©', 'üßë', 'üë®‚Äçüíº', 'üë©‚Äçüíº', 'üßë‚Äçüíº',
            'üë®‚Äçüåæ', 'üë©‚Äçüåæ', 'üßë‚Äçüåæ', 'üë®‚Äçüç≥', 'üë©‚Äçüç≥', 'üßë‚Äçüç≥',
            'üë®‚Äçüîß', 'üë©‚Äçüîß', 'üßë‚Äçüîß', 'üßô‚Äç‚ôÇÔ∏è', 'üßô‚Äç‚ôÄÔ∏è', 'üßô',
            'üßù‚Äç‚ôÇÔ∏è', 'üßù‚Äç‚ôÄÔ∏è', 'üßù', 'üßõ‚Äç‚ôÇÔ∏è', 'üßõ‚Äç‚ôÄÔ∏è', 'üßõ',
            'ü§¥', 'üë∏', 'ü¶∏‚Äç‚ôÇÔ∏è', 'ü¶∏‚Äç‚ôÄÔ∏è', 'ü¶π‚Äç‚ôÇÔ∏è', 'ü¶π‚Äç‚ôÄÔ∏è',
            'üëÆ‚Äç‚ôÇÔ∏è', 'üëÆ‚Äç‚ôÄÔ∏è', 'üïµÔ∏è‚Äç‚ôÇÔ∏è', 'üïµÔ∏è‚Äç‚ôÄÔ∏è', 'üíÇ‚Äç‚ôÇÔ∏è', 'üíÇ‚Äç‚ôÄÔ∏è',
            'ü•∑', 'üë∑‚Äç‚ôÇÔ∏è', 'üë∑‚Äç‚ôÄÔ∏è', 'üë®‚Äç‚öïÔ∏è', 'üë©‚Äç‚öïÔ∏è', 'üë®‚Äçüéì', 'üë©‚Äçüéì'
        ];
        
        let currentInventoryFilter = 'all';
        
        function renderCharacter() {
            // Update character profile
            const nameInput = document.getElementById('characterName');
            if (nameInput) nameInput.value = gameState.character.name;
            
            const avatarEl = document.getElementById('characterAvatar');
            if (avatarEl) avatarEl.textContent = gameState.character.avatar;
            
            // Calculate player level based on total actions
            const playerLevel = Math.floor(gameState.stats.actionsComplete / 50) + 1;
            gameState.character.level = playerLevel;
            
            const playerLevelEl = document.getElementById('playerLevel');
            if (playerLevelEl) playerLevelEl.textContent = playerLevel;
            
            // Calculate total wealth (Silver + inventory value + Gold value)
            let inventoryValue = 0;
            for (const [item, qty] of Object.entries(gameState.inventory)) {
                const baseValue = basePrices[item] || 5;
                inventoryValue += baseValue * qty;
            }
            const totalWealth = gameState.silver + inventoryValue + (gameState.gold * 1000);
            const totalWealthEl = document.getElementById('totalWealth');
            if (totalWealthEl) totalWealthEl.textContent = totalWealth.toLocaleString() + ' ü•à';
            
            // Update achievements count
            const unlockedAchievements = Object.values(gameState.achievements).filter(a => a.unlocked).length;
            const charAchievementsEl = document.getElementById('charAchievements');
            if (charAchievementsEl) charAchievementsEl.textContent = unlockedAchievements;
            
            // Update biomes unlocked
            const biomesUnlockedEl = document.getElementById('biomesUnlocked');
            if (biomesUnlockedEl) biomesUnlockedEl.textContent = `${gameState.progress.unlockedBiomes.length}/4`;
            
            // Update tools owned
            const toolsOwnedEl = document.getElementById('toolsOwned');
            if (toolsOwnedEl) toolsOwnedEl.textContent = Object.keys(gameState.tools).length;
            
            // Update workers hired
            const workersHiredEl = document.getElementById('workersHired');
            if (workersHiredEl) workersHiredEl.textContent = gameState.workers.length;
            
            // Update lifetime stats
            const charActionsCompleteEl = document.getElementById('charActionsComplete');
            if (charActionsCompleteEl) charActionsCompleteEl.textContent = gameState.stats.actionsComplete || 0;
            
            const charItemsCraftedEl = document.getElementById('charItemsCrafted');
            if (charItemsCraftedEl) charItemsCraftedEl.textContent = gameState.stats.itemsCrafted || 0;
            
            const charTradesMadeEl = document.getElementById('charTradesMade');
            if (charTradesMadeEl) charTradesMadeEl.textContent = gameState.stats.tradesMade || 0;
            
            const charSilverEarnedEl = document.getElementById('charSilverEarned');
            if (charSilverEarnedEl) charSilverEarnedEl.textContent = (gameState.stats.silverEarned || 0).toLocaleString() + ' ü•à';
            
            const charSilverSpentEl = document.getElementById('charSilverSpent');
            if (charSilverSpentEl) charSilverSpentEl.textContent = (gameState.stats.silverSpent || 0).toLocaleString() + ' ü•à';
            
            const netProfit = (gameState.stats.silverEarned || 0) - (gameState.stats.silverSpent || 0);
            const charNetProfitEl = document.getElementById('charNetProfit');
            if (charNetProfitEl) {
                charNetProfitEl.textContent = netProfit.toLocaleString() + ' ü•à';
                charNetProfitEl.style.color = netProfit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
            
            // Calculate play time
            const playTime = Math.floor((Date.now() - gameState.character.startTime) / 60000); // minutes
            const hours = Math.floor(playTime / 60);
            const minutes = playTime % 60;
            const playTimeEl = document.getElementById('playTime');
            if (playTimeEl) playTimeEl.textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            
            // Render badges
            renderCharacterBadges();
            
            // Render inventory
            renderInventory();
        }
        
        function renderCharacterBadges() {
            const container = document.getElementById('characterBadges');
            if (!container) return;
            
            const badges = [];
            
            // Premium badge
            if (hasPermanentUpgrade('premium_badge')) {
                badges.push('üëë');
            }
            
            // Achievement milestones
            const unlockedCount = Object.values(gameState.achievements).filter(a => a.unlocked).length;
            if (unlockedCount >= 30) badges.push('üèÜ');
            else if (unlockedCount >= 15) badges.push('ü•á');
            else if (unlockedCount >= 5) badges.push('ü•à');
            
            // Wealth badges
            if (gameState.silver >= 50000) badges.push('üí∞');
            else if (gameState.silver >= 10000) badges.push('ü•à');
            
            // Worker badges
            if (gameState.workers.length >= 6) badges.push('üëî');
            else if (gameState.workers.length >= 3) badges.push('üë∑');
            
            container.innerHTML = badges.map(badge => 
                `<span style="font-size: 1.5rem;">${badge}</span>`
            ).join('');
        }
        
        function renderInventory() {
            const container = document.getElementById('inventoryDisplay');
            if (!container) return;
            
            // Get items to display based on filter
            let itemsToShow = [];
            
            if (currentInventoryFilter === 'all') {
                itemsToShow = Object.keys(gameState.inventory);
            } else {
                itemsToShow = inventoryCategories[currentInventoryFilter] || [];
            }
            
            // Filter out items with 0 quantity
            itemsToShow = itemsToShow.filter(item => (gameState.inventory[item] || 0) > 0);
            
            // Calculate total items
            const totalItems = Object.values(gameState.inventory).reduce((sum, qty) => sum + qty, 0);
            const invTotalItemsEl = document.getElementById('invTotalItems');
            if (invTotalItemsEl) invTotalItemsEl.textContent = totalItems;
            
            if (itemsToShow.length === 0) {
                container.innerHTML = '<p class="card-description" style="grid-column: 1/-1;">No items in this category yet. Start gathering!</p>';
                return;
            }
            
            container.innerHTML = itemsToShow.map(item => {
                const quantity = gameState.inventory[item] || 0;
                const icon = itemIcons[item] || 'üì¶';
                const name = item.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const baseValue = basePrices[item] || 5;
                const totalValue = baseValue * quantity;
                
                return `
                    <div class="card">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 3rem; margin-bottom: 10px;">${icon}</div>
                            <h3 class="card-title" style="margin: 0;">${name}</h3>
                        </div>
                        <div class="card-stats">
                            <div class="stat-row">
                                <span class="stat-label">Quantity:</span>
                                <span class="stat-value">${quantity}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Unit Value:</span>
                                <span class="stat-value">${baseValue} ü•à</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Total Value:</span>
                                <span class="stat-value" style="color: var(--accent-gold);">${totalValue} ü•à</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="quickSellItem('${item}', ${quantity})">
                            Quick Sell All
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function filterInventory(category) {
            currentInventoryFilter = category;
            
            // Update button styles
            document.querySelectorAll('[id^="inv-filter-"]').forEach(btn => {
                btn.style.background = 'var(--bg-primary)';
                btn.style.borderColor = 'var(--border-color)';
            });
            
            const activeBtn = document.getElementById(`inv-filter-${category}`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--accent-blue)';
                activeBtn.style.borderColor = 'var(--accent-blue)';
            }
            
            renderInventory();
        }
        
        function quickSellItem(item, quantity) {
            if (!confirm(`Sell all ${quantity} ${item.replace(/_/g, ' ')} for ${(basePrices[item] || 5) * quantity} Silver?`)) {
                return;
            }
            
            const totalValue = (basePrices[item] || 5) * quantity;
            gameState.silver += totalValue;
            gameState.stats.silverEarned = (gameState.stats.silverEarned || 0) + totalValue;
            gameState.inventory[item] = 0;
            
            showNotification(`Sold ${quantity} ${item.replace(/_/g, ' ')} for ${totalValue} Silver!`, 'success');
            addActivity(`Quick sold ${quantity} ${item.replace(/_/g, ' ')} for ${totalValue} Silver`);
            
            renderInventory();
            renderCharacter();
            updateUI();
        }
        
        function updateCharacterName() {
            const nameInput = document.getElementById('characterName');
            if (nameInput && nameInput.value.trim()) {
                gameState.character.name = nameInput.value.trim();
                showNotification('Character name updated!', 'success');
            }
        }
        
        function openAvatarPicker() {
            const dialog = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;" id="avatarDialog" onclick="closeAvatarPicker(event)">
                    <div class="screen" style="max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2 class="screen-title">Choose Your Avatar</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin: 20px 0;">
                            ${avatarOptions.map(avatar => `
                                <button onclick="selectAvatar('${avatar}')" 
                                        style="font-size: 3rem; padding: 15px; background: var(--bg-tertiary); border: 2px solid ${avatar === gameState.character.avatar ? 'var(--accent-gold)' : 'var(--border-color)'}; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;"
                                        onmouseover="this.style.borderColor='var(--accent-blue)'"
                                        onmouseout="this.style.borderColor='${avatar === gameState.character.avatar ? 'var(--accent-gold)' : 'var(--border-color)'}'">
                                    ${avatar}
                                </button>
                            `).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="closeAvatarPicker()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialog);
        }
        
        function closeAvatarPicker(event) {
            if (event && event.target.id !== 'avatarDialog') return;
            const dialog = document.getElementById('avatarDialog');
            if (dialog) dialog.remove();
        }
        
        function selectAvatar(avatar) {
            gameState.character.avatar = avatar;
            showNotification('Avatar updated!', 'success');
            renderCharacter();
            closeAvatarPicker();
        }
        
        // MetaMask Wallet & Gold Store Functions
        const goldPackages = [
            {
                id: 'starter',
                name: 'Starter Pack',
                gold: 10,
                eth: '0.001',
                bonus: 0,
                popular: false
            },
            {
                id: 'value',
                name: 'Value Pack',
                gold: 50,
                eth: '0.004',
                bonus: 10,
                popular: true
            },
            {
                id: 'mega',
                name: 'Mega Pack',
                gold: 150,
                eth: '0.010',
                bonus: 50,
                popular: false
            },
            {
                id: 'ultimate',
                name: 'Ultimate Pack',
                gold: 500,
                eth: '0.030',
                bonus: 200,
                popular: false
            }
        ];
        
        // Base Network Configuration
        const BASE_MAINNET = {
            chainId: '0x2105', // 8453 in hex
            chainName: 'Base',
            nativeCurrency: {
                name: 'Ethereum',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://mainnet.base.org'],
            blockExplorerUrls: ['https://basescan.org']
        };
        
        const BASE_SEPOLIA = {
            chainId: '0x14a34', // 84532 in hex
            chainName: 'Base Sepolia',
            nativeCurrency: {
                name: 'Ethereum',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://sepolia.base.org'],
            blockExplorerUrls: ['https://sepolia.basescan.org']
        };
        
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showNotification('MetaMask not detected! Please install MetaMask extension.', 'error');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }
            
            try {
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const address = accounts[0];
                
                // Check network
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();
                const chainId = network.chainId;
                
                // Check if on Base network (8453 mainnet or 84532 sepolia)
                if (chainId !== 8453 && chainId !== 84532) {
                    showNotification('‚ö†Ô∏è Please switch to Base network', 'error');
                    
                    // Try to switch to Base mainnet
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_MAINNET.chainId }],
                        });
                    } catch (switchError) {
                        // If Base is not added, add it
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [BASE_MAINNET],
                                });
                            } catch (addError) {
                                console.error('Failed to add Base network:', addError);
                                showNotification('Failed to add Base network. Please add it manually.', 'error');
                                return;
                            }
                        } else {
                            console.error('Failed to switch network:', switchError);
                            showNotification('Failed to switch to Base network.', 'error');
                            return;
                        }
                    }
                    
                    // Reconnect after network switch
                    setTimeout(() => connectWallet(), 1000);
                    return;
                }
                
                // Get balance
                const balance = await provider.getBalance(address);
                const balanceInEth = ethers.utils.formatEther(balance);
                
                // Update game state
                gameState.wallet.connected = true;
                gameState.wallet.address = address;
                gameState.wallet.balance = parseFloat(balanceInEth);
                gameState.wallet.network = chainId === 8453 ? 'Base Mainnet' : 'Base Sepolia';
                
                // Update UI
                renderWalletStatus();
                renderGoldStore();
                
                showNotification(`Wallet connected on ${gameState.wallet.network}!`, 'success');
                playSound('success');
                addActivity(`Connected wallet: ${address.substring(0, 6)}...${address.substring(38)}`);
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
                
            } catch (error) {
                console.error('Wallet connection error:', error);
                showNotification('Failed to connect wallet. Please try again.', 'error');
                playSound('error');
            }
        }
        
        function handleChainChanged(chainId) {
            // Convert hex to decimal
            const decimalChainId = parseInt(chainId, 16);
            
            // Check if still on Base
            if (decimalChainId !== 8453 && decimalChainId !== 84532) {
                disconnectWallet();
                showNotification('‚ö†Ô∏è Disconnected - Please use Base network only', 'error');
            } else {
                // Refresh connection
                connectWallet();
            }
        }
        
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else {
                connectWallet(); // Reconnect with new account
            }
        }
        
        function disconnectWallet() {
            gameState.wallet.connected = false;
            gameState.wallet.address = null;
            gameState.wallet.balance = 0;
            gameState.wallet.network = null;
            
            renderWalletStatus();
            renderGoldStore();
            
            showNotification('Wallet disconnected', 'success');
        }
        
        function renderWalletStatus() {
            const walletStatusDiv = document.getElementById('walletStatus');
            const walletConnectedDiv = document.getElementById('walletConnected');
            
            if (!walletStatusDiv || !walletConnectedDiv) return;
            
            if (gameState.wallet.connected) {
                walletStatusDiv.style.display = 'none';
                walletConnectedDiv.style.display = 'block';
                
                const addressEl = document.getElementById('walletAddress');
                const balanceEl = document.getElementById('walletBalance');
                const networkEl = document.getElementById('walletNetwork');
                
                if (addressEl) {
                    const addr = gameState.wallet.address;
                    addressEl.textContent = `${addr.substring(0, 6)}...${addr.substring(38)}`;
                }
                
                if (balanceEl) {
                    balanceEl.textContent = `${gameState.wallet.balance.toFixed(4)} ETH`;
                }
                
                if (networkEl) {
                    networkEl.textContent = gameState.wallet.network || 'Base';
                }
            } else {
                walletStatusDiv.style.display = 'block';
                walletConnectedDiv.style.display = 'none';
            }
        }
        
        function renderGoldStore() {
            const container = document.getElementById('goldStorePackages');
            if (!container) return;
            
            if (!gameState.wallet.connected) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üîí</div>
                        <div>Connect your wallet to purchase Gold with ETH</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = goldPackages.map(pkg => {
                const totalGold = pkg.gold + pkg.bonus;
                const canAfford = gameState.wallet.balance >= parseFloat(pkg.eth);
                
                return `
                    <div style="padding: 15px; background: var(--bg-primary); border: 2px solid ${pkg.popular ? 'var(--accent-gold)' : 'var(--border-color)'}; border-radius: 8px; margin-bottom: 10px; position: relative;">
                        ${pkg.popular ? '<div style="position: absolute; top: -10px; right: 10px; padding: 4px 12px; background: var(--accent-gold); color: var(--bg-primary); font-size: 0.75rem; font-weight: 700; border-radius: 20px;">POPULAR</div>' : ''}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.1rem;">${pkg.name}</div>
                                <div style="font-size: 0.9rem; color: var(--accent-gold); margin-top: 5px;">
                                    ${pkg.gold} Gold ${pkg.bonus > 0 ? `<span style="color: var(--accent-green);">+${pkg.bonus} Bonus</span>` : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 3px;">
                                    ${pkg.eth} ETH
                                </div>
                            </div>
                            <button class="btn ${canAfford ? 'btn-primary' : 'btn-secondary'}" 
                                    onclick="purchaseGoldWithETH('${pkg.id}')" 
                                    ${!canAfford ? 'disabled' : ''}
                                    style="min-width: 100px;">
                                ${canAfford ? 'Buy Now' : 'Insufficient ETH'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function purchaseGoldWithETH(packageId) {
            const pkg = goldPackages.find(p => p.id === packageId);
            if (!pkg) return;
            
            if (!gameState.wallet.connected) {
                showNotification('Please connect your wallet first!', 'error');
                return;
            }
            
            const totalGold = pkg.gold + pkg.bonus;
            
            if (!confirm(`Purchase ${totalGold} Gold for ${pkg.eth} ETH?`)) {
                return;
            }
            
            try {
                // In a real implementation, this would send a transaction to a smart contract
                // For demo purposes, we'll simulate the purchase
                
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                
                // Create transaction
                const tx = {
                    to: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb', // Demo address (replace with real contract)
                    value: ethers.utils.parseEther(pkg.eth),
                    gasLimit: 21000
                };
                
                showNotification('Transaction pending... Please confirm in MetaMask', 'success');
                
                // Send transaction
                const transaction = await signer.sendTransaction(tx);
                
                showNotification('Processing transaction...', 'success');
                
                // Wait for confirmation
                await transaction.wait();
                
                // Award gold
                gameState.gold += totalGold;
                
                // Update balance
                const balance = await provider.getBalance(gameState.wallet.address);
                gameState.wallet.balance = parseFloat(ethers.utils.formatEther(balance));
                
                showNotification(`Successfully purchased ${totalGold} Gold!`, 'success');
                addActivity(`Purchased ${totalGold} Gold with ${pkg.eth} ETH`);
                
                renderGoldStore();
                renderWalletStatus();
                renderShop();
                updateUI();
                
            } catch (error) {
                console.error('Purchase error:', error);
                if (error.code === 4001) {
                    showNotification('Transaction rejected by user', 'error');
                } else {
                    showNotification('Transaction failed. Please try again.', 'error');
                }
            }
        }
        
        // Audio System
        let audioContext = null;
        let musicAudio = null;
        let musicTracks = {
            ambient: 'https://cdn.pixabay.com/audio/2022/03/10/audio_c8c6e0c440.mp3', // Placeholder - replace with your music
            upbeat: 'https://cdn.pixabay.com/audio/2022/03/15/audio_b07f0d9823.mp3',
            chill: 'https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3',
            adventure: 'https://cdn.pixabay.com/audio/2022/03/24/audio_67b94ca4d3.mp3'
        };
        
        function initAudioSystem() {
            // Create audio context for sound effects
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.warn('Web Audio API not supported');
            }
            
            // Create music audio element
            musicAudio = new Audio();
            musicAudio.loop = true;
            musicAudio.volume = gameState.audio.musicVolume;
            
            // Set initial track
            musicAudio.src = musicTracks[gameState.audio.currentTrack];
            
            // Handle autoplay policy - music will start on first user interaction
            document.addEventListener('click', startMusicOnInteraction, { once: true });
            
            // Update UI
            updateAudioUI();
        }
        
        function startMusicOnInteraction() {
            if (gameState.audio.musicEnabled && musicAudio) {
                musicAudio.play().catch(e => console.log('Music autoplay prevented'));
            }
        }
        
        function updateAudioUI() {
            // Update music toggle
            const musicStatus = document.getElementById('musicStatus');
            const musicToggle = document.getElementById('musicToggle');
            if (musicStatus) {
                musicStatus.textContent = gameState.audio.musicEnabled ? 'ON' : 'OFF';
            }
            if (musicToggle) {
                musicToggle.style.background = gameState.audio.musicEnabled ? 'var(--accent-green)' : 'var(--bg-primary)';
            }
            
            // Update SFX toggle
            const sfxStatus = document.getElementById('sfxStatus');
            const sfxToggle = document.getElementById('sfxToggle');
            if (sfxStatus) {
                sfxStatus.textContent = gameState.audio.sfxEnabled ? 'ON' : 'OFF';
            }
            if (sfxToggle) {
                sfxToggle.style.background = gameState.audio.sfxEnabled ? 'var(--accent-blue)' : 'var(--bg-primary)';
            }
            
            // Update volume displays
            const musicVolumeDisplay = document.getElementById('musicVolumeDisplay');
            const musicVolumeSlider = document.getElementById('musicVolumeSlider');
            if (musicVolumeDisplay) musicVolumeDisplay.textContent = Math.round(gameState.audio.musicVolume * 100);
            if (musicVolumeSlider) musicVolumeSlider.value = gameState.audio.musicVolume * 100;
            
            const sfxVolumeDisplay = document.getElementById('sfxVolumeDisplay');
            const sfxVolumeSlider = document.getElementById('sfxVolumeSlider');
            if (sfxVolumeDisplay) sfxVolumeDisplay.textContent = Math.round(gameState.audio.sfxVolume * 100);
            if (sfxVolumeSlider) sfxVolumeSlider.value = gameState.audio.sfxVolume * 100;
            
            // Update track select
            const trackSelect = document.getElementById('trackSelect');
            if (trackSelect) trackSelect.value = gameState.audio.currentTrack;
        }
        
        function toggleMusic() {
            gameState.audio.musicEnabled = !gameState.audio.musicEnabled;
            
            if (gameState.audio.musicEnabled) {
                musicAudio.play().catch(e => console.log('Music play prevented'));
            } else {
                musicAudio.pause();
            }
            
            updateAudioUI();
            saveGame(true);
        }
        
        function toggleSFX() {
            gameState.audio.sfxEnabled = !gameState.audio.sfxEnabled;
            updateAudioUI();
            saveGame(true);
            
            // Test sound when enabling
            if (gameState.audio.sfxEnabled) {
                playSound('success');
            }
        }
        
        function setMusicVolume(value) {
            gameState.audio.musicVolume = value / 100;
            if (musicAudio) {
                musicAudio.volume = gameState.audio.musicVolume;
            }
            updateAudioUI();
        }
        
        function setSFXVolume(value) {
            gameState.audio.sfxVolume = value / 100;
            updateAudioUI();
        }
        
        function changeTrack(trackId) {
            gameState.audio.currentTrack = trackId;
            
            if (musicAudio) {
                const wasPlaying = !musicAudio.paused;
                musicAudio.src = musicTracks[trackId];
                
                if (wasPlaying && gameState.audio.musicEnabled) {
                    musicAudio.play().catch(e => console.log('Track change play prevented'));
                }
            }
            
            saveGame(true);
        }
        
        function testSound() {
            playSound('test');
        }
        
        // Sound effect generator using Web Audio API
        function playSound(type) {
            if (!gameState.audio.sfxEnabled || !audioContext) return;
            
            try {
                const now = audioContext.currentTime;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                gainNode.gain.value = gameState.audio.sfxVolume * 0.3; // Keep subtle
                
                switch(type) {
                    case 'action_complete':
                        // Success chime - rising tone
                        oscillator.frequency.setValueAtTime(400, now);
                        oscillator.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        oscillator.type = 'sine';
                        break;
                        
                    case 'coin':
                        // Coin pickup - short high tone
                        oscillator.frequency.setValueAtTime(800, now);
                        oscillator.frequency.exponentialRampToValueAtTime(1000, now + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        oscillator.type = 'sine';
                        break;
                        
                    case 'craft':
                        // Crafting - hammer sound
                        oscillator.frequency.setValueAtTime(150, now);
                        gainNode.gain.setValueAtTime(gameState.audio.sfxVolume * 0.4, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        oscillator.type = 'square';
                        break;
                        
                    case 'level_up':
                        // Level up - fanfare
                        oscillator.frequency.setValueAtTime(523, now); // C
                        oscillator.frequency.setValueAtTime(659, now + 0.1); // E
                        oscillator.frequency.setValueAtTime(784, now + 0.2); // G
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                        oscillator.type = 'sine';
                        break;
                        
                    case 'purchase':
                        // Purchase - confirmation beep
                        oscillator.frequency.setValueAtTime(600, now);
                        oscillator.frequency.setValueAtTime(700, now + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                        oscillator.type = 'sine';
                        break;
                        
                    case 'error':
                        // Error - low buzz
                        oscillator.frequency.setValueAtTime(200, now);
                        oscillator.frequency.setValueAtTime(150, now + 0.1);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                        oscillator.type = 'sawtooth';
                        break;
                        
                    case 'achievement':
                        // Achievement - triumph
                        oscillator.frequency.setValueAtTime(400, now);
                        oscillator.frequency.setValueAtTime(500, now + 0.1);
                        oscillator.frequency.setValueAtTime(600, now + 0.2);
                        oscillator.frequency.setValueAtTime(800, now + 0.3);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                        oscillator.type = 'sine';
                        break;
                        
                    case 'click':
                        // UI click - short blip
                        oscillator.frequency.setValueAtTime(1000, now);
                        gainNode.gain.setValueAtTime(gameState.audio.sfxVolume * 0.2, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                        oscillator.type = 'sine';
                        break;
                        
                    case 'success':
                        // Success - pleasant chime
                        oscillator.frequency.setValueAtTime(800, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                        oscillator.type = 'sine';
                        break;
                        
                    case 'test':
                        // Test sound - full range
                        oscillator.frequency.setValueAtTime(440, now);
                        oscillator.frequency.exponentialRampToValueAtTime(880, now + 0.2);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                        oscillator.type = 'sine';
                        break;
                        
                    default:
                        // Default beep
                        oscillator.frequency.setValueAtTime(440, now);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                        oscillator.type = 'sine';
                }
                
                oscillator.start(now);
                oscillator.stop(now + 0.5);
                
            } catch (e) {
                console.warn('Sound effect error:', e);
            }
        }
        
        function initializeEconomy() {
            // Initialize NPC traders if not present
            if (Object.keys(gameState.economy.npcTraders).length === 0) {
                for (const [key, template] of Object.entries(npcTraderTemplates)) {
                    gameState.economy.npcTraders[key] = {
                        ...template,
                        priceMultipliers: {},
                        lastUpdate: Date.now()
                    };
                    
                    // Initialize price multipliers
                    [...template.buys, ...template.sells].forEach(item => {
                        gameState.economy.npcTraders[key].priceMultipliers[item] = 
                            0.8 + Math.random() * 0.4; // 0.8 to 1.2
                    });
                }
            }
            
            // Initialize price history if empty
            if (Object.keys(gameState.economy.priceHistory).length === 0) {
                for (const item of Object.keys(basePrices)) {
                    gameState.economy.priceHistory[item] = [];
                }
            }
            
            // Set initial tax payment time if not set
            if (!gameState.economy.lastTaxPayment) {
                gameState.economy.lastTaxPayment = Date.now();
            }
            
            // Initialize tax system fields
            if (gameState.economy.silverAtLastTax === undefined) {
                gameState.economy.silverAtLastTax = gameState.stats.silverEarned || 0;
            }
            if (!gameState.economy.taxType) {
                gameState.economy.taxType = 'income';
            }
            if (gameState.economy.taxRate === undefined || gameState.economy.taxRate === 50) {
                gameState.economy.taxRate = 0.10; // 10% default
            }
        }
        
        function updateEconomy() {
            // Update NPC trader prices (fluctuate randomly)
            for (const [key, trader] of Object.entries(gameState.economy.npcTraders)) {
                for (const item of [...trader.buys, ...trader.sells]) {
                    const currentMultiplier = trader.priceMultipliers[item];
                    const change = (Math.random() - 0.5) * 0.1; // -5% to +5%
                    trader.priceMultipliers[item] = Math.max(0.5, Math.min(1.5, currentMultiplier + change));
                }
                trader.lastUpdate = Date.now();
            }
            
            // Record price history
            recordPriceHistory();
            
            // Maybe trigger a market event
            if (!gameState.economy.currentEvent && Math.random() < 0.3) {
                triggerMarketEvent();
            }
            
            renderNPCTraders();
            renderPriceHistory();
        }
        
        function recordPriceHistory() {
            const timestamp = Date.now();
            
            for (const item of Object.keys(basePrices)) {
                const avgPrice = calculateAveragePrice(item);
                
                if (!gameState.economy.priceHistory[item]) {
                    gameState.economy.priceHistory[item] = [];
                }
                
                gameState.economy.priceHistory[item].push({
                    timestamp,
                    price: avgPrice
                });
                
                // Keep only last 24 data points (24 minutes)
                if (gameState.economy.priceHistory[item].length > 24) {
                    gameState.economy.priceHistory[item].shift();
                }
            }
        }
        
        function calculateAveragePrice(item) {
            let totalPrice = 0;
            let count = 0;
            
            for (const trader of Object.values(gameState.economy.npcTraders)) {
                if (trader.sells.includes(item)) {
                    const price = calculateNPCPrice(item, trader, 'sell');
                    totalPrice += price;
                    count++;
                }
            }
            
            return count > 0 ? Math.round(totalPrice / count) : basePrices[item];
        }
        
        function calculateNPCPrice(item, trader, action) {
            let basePrice = basePrices[item] || 10;
            let multiplier = trader.priceMultipliers[item] || 1.0;
            
            // Apply trader's base multiplier
            multiplier *= trader.baseMultiplier;
            
            // Apply market event effects
            if (gameState.economy.currentEvent) {
                const event = marketEvents.find(e => e.id === gameState.economy.currentEvent);
                if (event) {
                    const effectKey = event.effects[item] || event.effects['*'];
                    if (effectKey) {
                        multiplier *= effectKey[action];
                    }
                }
            }
            
            // Buying from NPC is more expensive
            if (action === 'sell') {
                multiplier *= 1.3;
            } else if (action === 'buy') {
                multiplier *= 0.7;
            }
            
            return Math.max(1, Math.round(basePrice * multiplier));
        }
        
        function renderNPCTraders() {
            const container = document.getElementById('npcTraders');
            
            container.innerHTML = Object.entries(gameState.economy.npcTraders).map(([key, trader]) => `
                <div class="card">
                    <h3 class="card-title">${trader.icon} ${trader.name}</h3>
                    <p class="card-description">${trader.description}</p>
                    
                    <div style="margin: 15px 0;">
                        <div style="font-size: 0.9rem; font-weight: 700; color: var(--accent-green); margin-bottom: 10px;">
                            üí∞ Buying (You Sell):
                        </div>
                        ${trader.buys.slice(0, 3).map(item => {
                            const price = calculateNPCPrice(item, trader, 'buy');
                            const owned = gameState.inventory[item] || 0;
                            return `
                                <div class="stat-row">
                                    <span>${item.replace(/_/g, ' ')}</span>
                                    <span style="color: ${owned > 0 ? 'var(--accent-green)' : 'var(--text-secondary)'}">
                                        ${price} ü•à (${owned})
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <div style="font-size: 0.9rem; font-weight: 700; color: var(--accent-blue); margin-bottom: 10px;">
                            üõí Selling (You Buy):
                        </div>
                        ${trader.sells.slice(0, 3).map(item => {
                            const price = calculateNPCPrice(item, trader, 'sell');
                            return `
                                <div class="stat-row">
                                    <span>${item.replace(/_/g, ' ')}</span>
                                    <span style="color: var(--accent-gold)">${price} ü•à</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <button class="btn btn-primary" onclick="openTraderDialog('${key}')">
                        Trade with ${trader.name.split(' ')[0]}
                    </button>
                </div>
            `).join('');
        }
        
        function openTraderDialog(traderKey) {
            const trader = gameState.economy.npcTraders[traderKey];
            
            const dialog = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;" id="traderDialog" onclick="closeTraderDialog(event)">
                    <div class="screen" style="max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2 class="screen-title">${trader.icon} ${trader.name}</h2>
                        <p class="card-description">${trader.description}</p>
                        
                        <div style="margin: 20px 0;">
                            <h3 class="card-title">Sell to ${trader.name.split(' ')[0]}</h3>
                            ${trader.buys.map(item => {
                                const price = calculateNPCPrice(item, trader, 'buy');
                                const owned = gameState.inventory[item] || 0;
                                return `
                                    <div class="market-item" style="margin-bottom: 10px;">
                                        <div class="market-info">
                                            <div class="market-item-name">${item.replace(/_/g, ' ')}</div>
                                            <div class="market-item-details">You have: ${owned}</div>
                                        </div>
                                        <div class="market-price">${price} ü•à</div>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn btn-secondary" onclick="tradeWithNPC('${traderKey}', '${item}', 'sell', 1)" ${owned < 1 ? 'disabled' : ''}>Sell 1</button>
                                            <button class="btn btn-secondary" onclick="tradeWithNPC('${traderKey}', '${item}', 'sell', 10)" ${owned < 10 ? 'disabled' : ''}>Sell 10</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h3 class="card-title">Buy from ${trader.name.split(' ')[0]}</h3>
                            ${trader.sells.map(item => {
                                const price = calculateNPCPrice(item, trader, 'sell');
                                return `
                                    <div class="market-item" style="margin-bottom: 10px;">
                                        <div class="market-info">
                                            <div class="market-item-name">${item.replace(/_/g, ' ')}</div>
                                        </div>
                                        <div class="market-price">${price} ü•à</div>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn btn-primary" onclick="tradeWithNPC('${traderKey}', '${item}', 'buy', 1)" ${gameState.silver < price ? 'disabled' : ''}>Buy 1</button>
                                            <button class="btn btn-primary" onclick="tradeWithNPC('${traderKey}', '${item}', 'buy', 10)" ${gameState.silver < price * 10 ? 'disabled' : ''}>Buy 10</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <button class="btn btn-secondary" onclick="closeTraderDialog()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialog);
        }
        
        function closeTraderDialog(event) {
            if (event && event.target.id !== 'traderDialog') return;
            const dialog = document.getElementById('traderDialog');
            if (dialog) dialog.remove();
        }
        
        function tradeWithNPC(traderKey, item, action, quantity) {
            const trader = gameState.economy.npcTraders[traderKey];
            const price = calculateNPCPrice(item, trader, action);
            const totalCost = price * quantity;
            
            if (action === 'buy') {
                if (gameState.silver < totalCost) {
                    showNotification('Not enough Silver!', 'error');
                    return;
                }
                
                gameState.silver -= totalCost;
                gameState.inventory[item] = (gameState.inventory[item] || 0) + quantity;
                gameState.stats.silverSpent += totalCost;
                
                showNotification(`Bought ${quantity} ${item.replace(/_/g, ' ')} for ${totalCost} Silver`, 'success');
                addActivity(`Bought ${quantity} ${item.replace(/_/g, ' ')} from ${trader.name} for ${totalCost} Silver`);
            } else {
                if ((gameState.inventory[item] || 0) < quantity) {
                    showNotification('Not enough items!', 'error');
                    return;
                }
                
                gameState.inventory[item] -= quantity;
                gameState.silver += totalCost;
                gameState.stats.silverEarned += totalCost;
                
                showNotification(`Sold ${quantity} ${item.replace(/_/g, ' ')} for ${totalCost} Silver`, 'success');
                addActivity(`Sold ${quantity} ${item.replace(/_/g, ' ')} to ${trader.name} for ${totalCost} Silver`);
            }
            
            gameState.stats.tradesMade++;
            checkQuestProgress('trade', null, 1);
            
            // Close and reopen dialog to refresh prices
            closeTraderDialog();
            openTraderDialog(traderKey);
            updateUI();
        }
        
        function renderPriceHistory() {
            const container = document.getElementById('priceHistory');
            
            // Get top traded items
            const topItems = ['wood', 'stone', 'iron_ore', 'fish', 'gem', 'iron_bar'];
            
            container.innerHTML = topItems.map(item => {
                const history = gameState.economy.priceHistory[item] || [];
                const currentPrice = history.length > 0 ? history[history.length - 1].price : basePrices[item];
                const oldPrice = history.length > 1 ? history[0].price : currentPrice;
                const change = currentPrice - oldPrice;
                const changePercent = oldPrice > 0 ? ((change / oldPrice) * 100).toFixed(1) : 0;
                
                return `
                    <div style="padding: 15px; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 10px;">
                        <div style="font-size: 0.9rem; font-weight: 700; margin-bottom: 5px;">
                            ${item.replace(/_/g, ' ')}
                        </div>
                        <div style="font-size: 1.4rem; font-weight: 700; color: var(--accent-gold); margin-bottom: 5px;">
                            ${currentPrice} ü•à
                        </div>
                        <div style="font-size: 0.85rem; color: ${change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
                            ${change >= 0 ? 'üìà' : 'üìâ'} ${change >= 0 ? '+' : ''}${changePercent}%
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function triggerMarketEvent() {
            const event = marketEvents[Math.floor(Math.random() * marketEvents.length)];
            gameState.economy.currentEvent = event.id;
            gameState.economy.eventEndTime = Date.now() + event.duration;
            
            showNotification(`Market Event: ${event.name}!`, 'success');
            addActivity(`Market Event started: ${event.name}`);
            
            checkMarketEvent();
        }
        
        function checkMarketEvent() {
            const eventsContainer = document.getElementById('marketEvents');
            
            if (gameState.economy.currentEvent && gameState.economy.eventEndTime > Date.now()) {
                const event = marketEvents.find(e => e.id === gameState.economy.currentEvent);
                const timeLeft = Math.round((gameState.economy.eventEndTime - Date.now()) / 1000);
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                eventsContainer.innerHTML = `
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(42, 157, 143, 0.2), rgba(69, 123, 157, 0.2)); border: 2px solid var(--accent-green); border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: var(--accent-green); margin-bottom: 5px;">
                                    ${event.icon} ${event.name}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    ${event.description}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Time Remaining</div>
                                <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-gold);">
                                    ${minutes}:${seconds.toString().padStart(2, '0')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                setTimeout(() => checkMarketEvent(), 1000);
            } else if (gameState.economy.currentEvent && gameState.economy.eventEndTime <= Date.now()) {
                gameState.economy.currentEvent = null;
                gameState.economy.eventEndTime = null;
                eventsContainer.innerHTML = '';
                showNotification('Market event ended', 'success');
                renderNPCTraders();
            } else {
                eventsContainer.innerHTML = '';
            }
        }
        
        function checkTaxes() {
            const timeSinceLastTax = Date.now() - gameState.economy.lastTaxPayment;
            const taxPeriod = 300000; // 5 minutes for gameplay
            
            const timeUntilTax = taxPeriod - (timeSinceLastTax % taxPeriod);
            const minutes = Math.floor(timeUntilTax / 60000);
            const seconds = Math.floor((timeUntilTax % 60000) / 1000);
            
            const nextTaxEl = document.getElementById('nextTaxTime');
            if (nextTaxEl) {
                nextTaxEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Calculate tax amount for display
            const taxAmount = calculateTaxAmount();
            const dailyTaxAmountEl = document.getElementById('dailyTaxAmount');
            if (dailyTaxAmountEl) {
                if (gameState.economy.taxType === 'income') {
                    dailyTaxAmountEl.textContent = `${Math.floor(gameState.economy.taxRate * 100)}% Income`;
                } else {
                    dailyTaxAmountEl.textContent = `${Math.floor(gameState.economy.taxRate * 100)}% Wealth`;
                }
            }
            
            // Auto-pay tax when due
            if (timeSinceLastTax >= taxPeriod) {
                payTax();
            }
        }
        
        function calculateTaxAmount() {
            if (gameState.economy.taxType === 'income') {
                // Tax on income earned since last tax payment
                const earnedSinceTax = (gameState.stats.silverEarned || 0) - (gameState.economy.silverAtLastTax || 0);
                return Math.floor(earnedSinceTax * gameState.economy.taxRate);
            } else {
                // Tax on current wealth
                return Math.floor(gameState.silver * gameState.economy.taxRate);
            }
        }
        
        function payTax() {
            const taxAmount = calculateTaxAmount();
            
            if (taxAmount <= 0) {
                gameState.economy.lastTaxPayment = Date.now();
                gameState.economy.silverAtLastTax = gameState.stats.silverEarned || 0;
                showNotification(`No tax owed this period`, 'success');
                return;
            }
            
            if (gameState.silver >= taxAmount) {
                gameState.silver -= taxAmount;
                gameState.economy.lastTaxPayment = Date.now();
                gameState.economy.silverAtLastTax = gameState.stats.silverEarned || 0;
                
                const taxType = gameState.economy.taxType === 'income' ? 'income' : 'wealth';
                showNotification(`Paid ${taxType} tax: ${taxAmount} Silver`, 'success');
                addActivity(`Paid ${taxType} tax: ${taxAmount} Silver`);
            } else {
                // Can't pay - apply penalty
                const penalty = Math.floor(gameState.silver * 0.5);
                gameState.silver -= penalty;
                gameState.economy.lastTaxPayment = Date.now();
                gameState.economy.silverAtLastTax = gameState.stats.silverEarned || 0;
                showNotification(`‚ö†Ô∏è Insufficient funds for tax! Penalty: ${penalty} Silver`, 'error');
                addActivity(`Tax penalty applied: ${penalty} Silver`);
            }
            
            updateUI();
        }
        
        function payTaxEarly() {
            payTax();
        }

        function switchScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('.content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenName).classList.add('active');
            
            // Set active tab
            document.querySelector(`[data-screen="${screenName}"]`).classList.add('active');
        }

        function updateBiomeSelector() {
            const biomeSelect = document.getElementById('biomeSelect');
            const biomeRequirement = document.getElementById('biomeRequirement');
            const currentBiome = gameState.progress.currentBiome;
            
            biomeSelect.value = currentBiome;
            
            const biome = biomes[currentBiome];
            biomeRequirement.textContent = biome.requirement;
            
            // Check biome unlocks
            if (!gameState.progress.unlockedBiomes.includes('mountains') && 
                (gameState.inventory.stone >= 100 || gameState.inventory.iron_bar >= 50)) {
                gameState.progress.unlockedBiomes.push('mountains');
                showNotification('Mountains biome unlocked!', 'success');
            }
            
            if (!gameState.progress.unlockedBiomes.includes('ocean') && 
                (gameState.inventory.fish >= 50)) {
                gameState.progress.unlockedBiomes.push('ocean');
                showNotification('Ocean biome unlocked!', 'success');
            }
            
            if (!gameState.progress.unlockedBiomes.includes('caves') && 
                (gameState.inventory.silver_ore >= 100)) {
                gameState.progress.unlockedBiomes.push('caves');
                showNotification('Caves biome unlocked!', 'success');
            }
        }
        
        function changeBiome(biomeName) {
            if (!gameState.progress.unlockedBiomes.includes(biomeName)) {
                showNotification('Biome not unlocked yet!', 'error');
                document.getElementById('biomeSelect').value = gameState.progress.currentBiome;
                return;
            }
            
            gameState.progress.currentBiome = biomeName;
            renderBiomeActions();
            updateBiomeSelector();
        }

        function renderBiomeActions() {
            const container = document.getElementById('biomeActions');
            const currentBiome = biomes[gameState.progress.currentBiome];
            const actions = currentBiome.actions;
            
            container.innerHTML = actions.map(action => {
                const toolStatus = action.tool ? checkToolStatus(action.tool) : { canUse: true, message: '' };
                const isActive = gameState.activeActions[action.id];
                
                return `
                <div class="card ${isActive ? 'action-active' : ''}" id="action-${action.id}">
                    <h3 class="card-title">${action.icon} ${action.name}</h3>
                    <p class="card-description">${action.description}</p>
                    <div class="card-stats">
                        <div class="stat-row">
                            <span class="stat-label">Cost:</span>
                            <span class="stat-value">${action.cost} Silver</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Duration:</span>
                            <span class="stat-value">${action.duration / 1000}s</span>
                        </div>
                        ${action.tool ? `
                        <div class="stat-row">
                            <span class="stat-label">Tool:</span>
                            <span class="stat-value">${action.tool.replace('_', ' ')}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Tool Wear:</span>
                            <span class="stat-value">-${action.toolWear} durability</span>
                        </div>
                        ` : ''}
                        <div class="stat-row">
                            <span class="stat-label">Rewards:</span>
                            <span class="stat-value">${formatRewards(action.reward)}</span>
                        </div>
                    </div>
                    ${!toolStatus.canUse ? `
                        <div style="padding: 10px; background: rgba(231, 111, 81, 0.2); border: 1px solid var(--accent-red); border-radius: 6px; margin: 10px 0; font-size: 0.85rem;">
                            ‚ö†Ô∏è ${toolStatus.message}
                        </div>
                    ` : ''}
                    <div id="progress-${action.id}" style="display: none;">
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Progress</span>
                                <span id="timer-${action.id}">0s</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="fill-${action.id}" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="startAction('${action.id}')" id="btn-${action.id}" ${!toolStatus.canUse ? 'disabled' : ''}>
                        ${isActive ? 'In Progress...' : 'Start Action'}
                    </button>
                </div>
            `;
            }).join('');
        }
        
        function checkToolStatus(toolName) {
            if (!gameState.tools[toolName]) {
                return {
                    canUse: false,
                    message: `${toolName.replace('_', ' ')} not owned. Craft one first!`
                };
            }
            
            if (gameState.tools[toolName].durability <= 0) {
                return {
                    canUse: false,
                    message: `${toolName.replace('_', ' ')} is broken! Repair it in the Tools tab.`
                };
            }
            
            if (gameState.tools[toolName].durability < 10) {
                return {
                    canUse: true,
                    message: `Warning: ${toolName.replace('_', ' ')} is almost broken!`
                };
            }
            
            return { canUse: true, message: '' };
        }

        function formatRewards(reward) {
            const parts = [];
            for (const [key, value] of Object.entries(reward)) {
                if (key === 'silver') {
                    parts.push(`${value} ü•à`);
                } else {
                    parts.push(`${value} ${key}`);
                }
            }
            return parts.join(', ');
        }

        function startAction(actionId) {
            // Check if any action is already active (single action at a time)
            const activeActionKeys = Object.keys(gameState.activeActions);
            if (activeActionKeys.length > 0) {
                showNotification('‚ö†Ô∏è Only one action at a time! Complete current action first.', 'error');
                playSound('error');
                return;
            }
            
            // Find action in current biome
            const currentBiome = biomes[gameState.progress.currentBiome];
            const action = currentBiome.actions.find(a => a.id === actionId);
            
            if (!action) return;
            
            if (gameState.silver < action.cost) {
                showNotification('Not enough Silver!', 'error');
                playSound('error');
                return;
            }
            
            // Check tool
            if (action.tool) {
                const toolStatus = checkToolStatus(action.tool);
                if (!toolStatus.canUse) {
                    showNotification(toolStatus.message, 'error');
                    playSound('error');
                    return;
                }
            }

            if (gameState.activeActions[actionId]) {
                showNotification('Action already in progress!', 'error');
                playSound('error');
                return;
            }

            // Deduct cost
            gameState.silver -= action.cost;
            gameState.stats.silverSpent = (gameState.stats.silverSpent || 0) + action.cost;
            gameState.stats.totalActions++;
            
            // Apply speed boosts
            let actualDuration = action.duration;
            const speedBoost = hasActiveBoost('actionSpeed');
            if (speedBoost) {
                actualDuration = Math.floor(actualDuration / speedBoost);
            }
            
            // Mark action as active
            gameState.activeActions[actionId] = {
                startTime: Date.now(),
                duration: actualDuration,
                originalDuration: action.duration,
                action: action
            };

            // Update UI
            const progressDiv = document.getElementById(`progress-${actionId}`);
            const button = document.getElementById(`btn-${actionId}`);
            const card = document.getElementById(`action-${actionId}`);
            
            if (progressDiv && button && card) {
                progressDiv.style.display = 'block';
                button.disabled = true;
                button.textContent = 'In Progress...';
                card.classList.add('action-active');
            }

            // Start progress animation
            const interval = setInterval(() => {
                const elapsed = Date.now() - gameState.activeActions[actionId].startTime;
                const progress = (elapsed / action.duration) * 100;
                
                const fillEl = document.getElementById(`fill-${actionId}`);
                const timerEl = document.getElementById(`timer-${actionId}`);
                
                if (fillEl) fillEl.style.width = `${progress}%`;
                if (timerEl) timerEl.textContent = `${((action.duration - elapsed) / 1000).toFixed(1)}s`;

                if (elapsed >= action.duration) {
                    clearInterval(interval);
                    completeAction(actionId);
                }
            }, 100);

            updateUI();
        }

        function completeAction(actionId) {
            if (!gameState.activeActions[actionId]) return;
            
            const action = gameState.activeActions[actionId].action;
            
            // Apply output boost
            const outputBoost = hasActiveBoost('outputBoost') || 1.0;
            
            // Award rewards
            for (const [key, value] of Object.entries(action.reward)) {
                const boostedValue = Math.floor(value * outputBoost);
                
                if (key === 'silver') {
                    gameState.silver += boostedValue;
                    gameState.stats.silverEarned = (gameState.stats.silverEarned || 0) + boostedValue;
                    checkQuestProgress('silver_earned', null, boostedValue);
                } else {
                    gameState.inventory[key] = (gameState.inventory[key] || 0) + boostedValue;
                    checkQuestProgress('gather', key, boostedValue);
                }
            }
            
            // Track action completion
            checkQuestProgress('actions', null, 1);
            
            // Apply tool wear
            if (action.tool && gameState.tools[action.tool]) {
                gameState.tools[action.tool].durability -= action.toolWear;
                if (gameState.tools[action.tool].durability < 0) {
                    gameState.tools[action.tool].durability = 0;
                }
            }

            // Log activity
            addActivity(`Completed ${action.name} - earned ${formatRewards(action.reward)}`);
            
            // Clear active action
            delete gameState.activeActions[actionId];
            gameState.stats.actionsComplete++;

            // Reset UI
            const progressDiv = document.getElementById(`progress-${actionId}`);
            const button = document.getElementById(`btn-${actionId}`);
            const card = document.getElementById(`action-${actionId}`);
            
            if (progressDiv) progressDiv.style.display = 'none';
            if (card) card.classList.remove('action-active');
            if (button) {
                button.textContent = 'Start Action';
            }
            
            const fillEl = document.getElementById(`fill-${actionId}`);
            if (fillEl) fillEl.style.width = '0%';

            showNotification(`${action.name} complete!`, 'success');
            playSound('action_complete');
            
            // Play coin sound if silver was earned
            if (action.reward.silver) {
                setTimeout(() => playSound('coin'), 100);
            }
            
            renderBiomeActions(); // Re-render to update tool status
            renderTools(); // Update tools display
            updateUI();
        }

        function renderCraftingRecipes() {
            const container = document.getElementById('craftingRecipes');
            
            container.innerHTML = craftingRecipes.map(recipe => {
                const canCraft = checkCraftingRequirements(recipe);
                const isActive = gameState.activeActions[`craft_${recipe.id}`];
                
                return `
                <div class="card ${isActive ? 'action-active' : ''}" id="craft-${recipe.id}">
                    <h3 class="card-title">${recipe.icon} ${recipe.name}</h3>
                    <p class="card-description">${recipe.description}</p>
                    <div class="card-stats">
                        <div class="stat-row">
                            <span class="stat-label">Tier:</span>
                            <span class="stat-value">${recipe.tier}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Cost:</span>
                            <span class="stat-value">${recipe.cost} Silver</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Time:</span>
                            <span class="stat-value">${recipe.duration / 1000}s</span>
                        </div>
                    </div>
                    <div style="margin: 15px 0; padding: 15px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">Required:</div>
                        ${Object.entries(recipe.ingredients).map(([item, qty]) => `
                            <div class="stat-row">
                                <span>${item.replace('_', ' ')}</span>
                                <span style="color: ${(gameState.inventory[item] || 0) >= qty ? 'var(--accent-green)' : 'var(--accent-red)'}">
                                    ${gameState.inventory[item] || 0} / ${qty}
                                </span>
                            </div>
                        `).join('')}
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">Output:</div>
                            ${Object.entries(recipe.output).map(([item, qty]) => `
                                <div class="stat-row">
                                    <span>${item.replace('_', ' ')}</span>
                                    <span style="color: var(--accent-green)">+${qty}</span>
                                </div>
                            `).join('')}
                            ${recipe.silver ? `
                                <div class="stat-row">
                                    <span>Silver</span>
                                    <span style="color: var(--accent-gold)">+${recipe.silver}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${!canCraft.canCraft ? `
                        <div style="padding: 10px; background: rgba(231, 111, 81, 0.2); border: 1px solid var(--accent-red); border-radius: 6px; margin: 10px 0; font-size: 0.85rem;">
                            ‚ö†Ô∏è ${canCraft.message}
                        </div>
                    ` : ''}
                    <div id="progress-craft-${recipe.id}" style="display: none;">
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Crafting...</span>
                                <span id="timer-craft-${recipe.id}">0s</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="fill-craft-${recipe.id}" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="startCrafting('${recipe.id}')" id="btn-craft-${recipe.id}" ${!canCraft.canCraft || isActive ? 'disabled' : ''}>
                        ${isActive ? 'Crafting...' : 'Craft'}
                    </button>
                </div>
            `;
            }).join('');
        }
        
        function checkCraftingRequirements(recipe) {
            if (gameState.silver < recipe.cost) {
                return { canCraft: false, message: 'Not enough Silver!' };
            }
            
            for (const [item, qty] of Object.entries(recipe.ingredients)) {
                if ((gameState.inventory[item] || 0) < qty) {
                    return { canCraft: false, message: `Not enough ${item.replace('_', ' ')}!` };
                }
            }
            
            return { canCraft: true, message: '' };
        }
        
        function startCrafting(recipeId) {
            // Check if any action is already active (single action at a time)
            const activeActionKeys = Object.keys(gameState.activeActions);
            if (activeActionKeys.length > 0) {
                showNotification('‚ö†Ô∏è Only one action at a time! Complete current action first.', 'error');
                playSound('error');
                return;
            }
            
            const recipe = craftingRecipes.find(r => r.id === recipeId);
            if (!recipe) return;
            
            const canCraft = checkCraftingRequirements(recipe);
            if (!canCraft.canCraft) {
                showNotification(canCraft.message, 'error');
                playSound('error');
                return;
            }
            
            const actionId = `craft_${recipeId}`;
            if (gameState.activeActions[actionId]) {
                showNotification('Already crafting this item!', 'error');
                playSound('error');
                return;
            }
            
            // Deduct costs and ingredients
            gameState.silver -= recipe.cost;
            gameState.stats.silverSpent = (gameState.stats.silverSpent || 0) + recipe.cost;
            for (const [item, qty] of Object.entries(recipe.ingredients)) {
                gameState.inventory[item] -= qty;
            }
            
            // Mark as active
            gameState.activeActions[actionId] = {
                startTime: Date.now(),
                duration: recipe.duration,
                recipe: recipe
            };
            
            // Update UI
            const progressDiv = document.getElementById(`progress-craft-${recipeId}`);
            const button = document.getElementById(`btn-craft-${recipeId}`);
            const card = document.getElementById(`craft-${recipeId}`);
            
            if (progressDiv) progressDiv.style.display = 'block';
            if (button) {
                button.disabled = true;
                button.textContent = 'Crafting...';
            }
            if (card) card.classList.add('action-active');
            
            // Progress animation
            const interval = setInterval(() => {
                const elapsed = Date.now() - gameState.activeActions[actionId].startTime;
                const progress = (elapsed / recipe.duration) * 100;
                
                const fillEl = document.getElementById(`fill-craft-${recipeId}`);
                const timerEl = document.getElementById(`timer-craft-${recipeId}`);
                
                if (fillEl) fillEl.style.width = `${progress}%`;
                if (timerEl) timerEl.textContent = `${((recipe.duration - elapsed) / 1000).toFixed(1)}s`;
                
                if (elapsed >= recipe.duration) {
                    clearInterval(interval);
                    completeCrafting(recipeId);
                }
            }, 100);
            
            renderCraftingRecipes();
            updateUI();
        }
        
        function completeCrafting(recipeId) {
            const actionId = `craft_${recipeId}`;
            if (!gameState.activeActions[actionId]) return;
            
            const recipe = gameState.activeActions[actionId].recipe;
            
            // Award outputs
            for (const [item, qty] of Object.entries(recipe.output)) {
                if (recipe.toolCraft) {
                    // Create new tool
                    gameState.tools[item] = {
                        durability: 200,
                        maxDurability: 200
                    };
                } else {
                    gameState.inventory[item] = (gameState.inventory[item] || 0) + qty;
                }
            }
            
            if (recipe.silver) {
                gameState.silver += recipe.silver;
                gameState.stats.silverEarned = (gameState.stats.silverEarned || 0) + recipe.silver;
                checkQuestProgress('silver_earned', null, recipe.silver);
            }
            
            gameState.stats.itemsCrafted++;
            checkQuestProgress('craft', null, 1);
            
            // Log activity
            addActivity(`Crafted ${recipe.name}!`);
            
            // Clear active
            delete gameState.activeActions[actionId];
            
            // Reset UI
            const progressDiv = document.getElementById(`progress-craft-${recipeId}`);
            const card = document.getElementById(`craft-${recipeId}`);
            
            if (progressDiv) progressDiv.style.display = 'none';
            if (card) card.classList.remove('action-active');
            
            const fillEl = document.getElementById(`fill-craft-${recipeId}`);
            if (fillEl) fillEl.style.width = '0%';
            
            showNotification(`${recipe.name} crafted!`, 'success');
            playSound('craft');
            renderCraftingRecipes();
            renderTools();
            renderBiomeActions(); // Update actions if new tools available
            updateUI();
        }
        
        function renderTools() {
            const container = document.getElementById('toolsList');
            const toolEntries = Object.entries(gameState.tools);
            
            if (toolEntries.length === 0) {
                container.innerHTML = '<p class="card-description">No tools yet. Craft some in the Crafting tab!</p>';
                return;
            }
            
            container.innerHTML = toolEntries.map(([toolName, tool]) => {
                const durabilityPercent = (tool.durability / tool.maxDurability) * 100;
                const repairCost = Math.floor((tool.maxDurability - tool.durability) * 2);
                const isBroken = tool.durability <= 0;
                
                return `
                <div class="card">
                    <h3 class="card-title">${toolName.replace('_', ' ')}</h3>
                    <div class="card-stats">
                        <div class="stat-row">
                            <span class="stat-label">Durability:</span>
                            <span class="stat-value" style="color: ${isBroken ? 'var(--accent-red)' : durabilityPercent < 30 ? 'var(--accent-gold)' : 'var(--accent-green)'}">
                                ${tool.durability} / ${tool.maxDurability}
                            </span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Status:</span>
                            <span class="stat-value">
                                ${isBroken ? 'üî¥ Broken' : durabilityPercent < 30 ? 'üü° Low' : 'üü¢ Good'}
                            </span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Repair Cost:</span>
                            <span class="stat-value">${repairCost} Silver</span>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${durabilityPercent}%; background: ${isBroken ? 'var(--accent-red)' : durabilityPercent < 30 ? 'var(--accent-gold)' : 'linear-gradient(90deg, var(--accent-blue), var(--accent-green))'}"></div>
                        </div>
                    </div>
                    <button class="btn ${tool.durability === tool.maxDurability ? 'btn-secondary' : 'btn-primary'}" 
                            onclick="repairTool('${toolName}')" 
                            ${tool.durability === tool.maxDurability || gameState.silver < repairCost ? 'disabled' : ''}>
                        ${tool.durability === tool.maxDurability ? 'Fully Repaired' : `Repair (${repairCost} Silver)`}
                    </button>
                </div>
            `;
            }).join('');
        }
        
        function repairTool(toolName) {
            const tool = gameState.tools[toolName];
            if (!tool) return;
            
            let repairCost = Math.floor((tool.maxDurability - tool.durability) * 2);
            
            // Apply repair discount if owned
            if (hasPermanentUpgrade('tool_repair_discount')) {
                repairCost = Math.floor(repairCost * 0.5); // 50% off
            }
            
            if (gameState.silver < repairCost) {
                showNotification('Not enough Silver!', 'error');
                return;
            }
            
            gameState.silver -= repairCost;
            gameState.stats.silverSpent = (gameState.stats.silverSpent || 0) + repairCost;
            tool.durability = tool.maxDurability;
            
            showNotification(`${toolName.replace('_', ' ')} repaired!`, 'success');
            addActivity(`Repaired ${toolName.replace('_', ' ')} for ${repairCost} Silver`);
            
            renderTools();
            renderBiomeActions(); // Update actions with repaired tool
            updateUI();
        }
        
        function checkToolDurability() {
            for (const [toolName, tool] of Object.entries(gameState.tools)) {
                if (tool.durability <= 0 && tool.durability !== 0) {
                    showNotification(`‚ö†Ô∏è ${toolName.replace('_', ' ')} has broken!`, 'error');
                    tool.durability = 0; // Prevent multiple notifications
                }
            }
        }

        function createListing() {
            const item = document.getElementById('listingItem').value;
            const quantity = parseInt(document.getElementById('listingQuantity').value);
            const price = parseInt(document.getElementById('listingPrice').value);

            if (!item || !quantity || !price) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            if ((gameState.inventory[item] || 0) < quantity) {
                showNotification('Not enough items in inventory!', 'error');
                return;
            }

            // Remove from inventory
            gameState.inventory[item] -= quantity;

            // Create listing
            const listing = {
                id: Date.now(),
                item,
                quantity,
                price,
                seller: 'You',
                created: new Date().toISOString()
            };

            gameState.marketListings.push(listing);
            
            // Clear form
            document.getElementById('listingItem').value = '';
            document.getElementById('listingQuantity').value = '';
            document.getElementById('listingPrice').value = '';

            showNotification('Listing created!', 'success');
            renderMarket();
            updateUI();
        }

        function buyListing(listingId) {
            const listing = gameState.marketListings.find(l => l.id === listingId);
            
            if (!listing) return;

            const totalCost = listing.price;
            
            if (gameState.silver < totalCost) {
                showNotification('Not enough Silver!', 'error');
                return;
            }

            // Deduct silver
            gameState.silver -= totalCost;

            // Add to inventory
            gameState.inventory[listing.item] = (gameState.inventory[listing.item] || 0) + listing.quantity;

            // Calculate market fee (3%)
            const fee = Math.floor(totalCost * 0.03);
            const sellerReceives = totalCost - fee;

            // Remove listing
            gameState.marketListings = gameState.marketListings.filter(l => l.id !== listingId);

            addActivity(`Bought ${listing.quantity} ${listing.item} for ${totalCost} Silver (${fee} fee)`);
            showNotification('Purchase successful!', 'success');
            renderMarket();
            updateUI();
        }

        function cancelListing(listingId) {
            const listing = gameState.marketListings.find(l => l.id === listingId);
            
            if (!listing) return;

            // Return items to inventory
            gameState.inventory[listing.item] = (gameState.inventory[listing.item] || 0) + listing.quantity;

            // Remove listing
            gameState.marketListings = gameState.marketListings.filter(l => l.id !== listingId);

            showNotification('Listing cancelled', 'success');
            renderMarket();
            updateUI();
        }

        function renderMarket() {
            const container = document.getElementById('marketListings');
            
            if (gameState.marketListings.length === 0) {
                container.innerHTML = '<p class="card-description">No items currently listed. Create a listing to start trading!</p>';
                return;
            }

            container.innerHTML = gameState.marketListings.map(listing => `
                <div class="market-item">
                    <div class="market-info">
                        <div class="market-item-name">${listing.quantity}x ${listing.item}</div>
                        <div class="market-item-details">Seller: ${listing.seller}</div>
                    </div>
                    <div class="market-price">${listing.price} ü•à</div>
                    <div style="display: flex; gap: 10px;">
                        ${listing.seller === 'You' ? 
                            `<button class="btn btn-secondary" onclick="cancelListing(${listing.id})">Cancel</button>` :
                            `<button class="btn btn-primary" onclick="buyListing(${listing.id})">Buy</button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        function hireWorker() {
            const maxWorkers = getMaxWorkerSlots();
            
            if (gameState.workers.length >= maxWorkers) {
                showNotification('Maximum workers reached! Purchase more slots in the Shop.', 'error');
                return;
            }
            
            const typeSelect = document.getElementById('workerTypeSelect');
            const workerTypeKey = typeSelect.value;
            const workerType = workerTypes[workerTypeKey];
            
            if (gameState.silver < workerType.cost) {
                showNotification('Not enough Silver!', 'error');
                return;
            }

            gameState.silver -= workerType.cost;
            gameState.stats.silverSpent = (gameState.stats.silverSpent || 0) + workerType.cost;
            
            // Roll for trait
            const trait = rollWorkerTrait();
            
            const worker = {
                id: Date.now(),
                name: generateWorkerName(),
                type: workerTypeKey,
                task: null,
                production: 0,
                upkeep: workerType.baseUpkeep,
                level: 1,
                xp: 0,
                xpToNext: 100,
                trait: trait,
                equipment: {
                    hands: null,
                    feet: null,
                    head: null
                },
                totalProduced: 0
            };

            gameState.workers.push(worker);
            
            showNotification(`Hired ${workerType.name}: ${worker.name} (${workerTraits[trait].name})!`, 'success');
            addActivity(`Hired ${worker.name} the ${workerType.name} for ${workerType.cost} Silver`);
            
            renderWorkers();
            updateUI();
        }
        
        function rollWorkerTrait() {
            const roll = Math.random();
            
            // 15% rare, 30% uncommon, 55% common
            if (roll < 0.15) {
                // Rare traits
                const rareTraits = Object.keys(workerTraits).filter(k => workerTraits[k].rarity === 'rare');
                return rareTraits[Math.floor(Math.random() * rareTraits.length)];
            } else if (roll < 0.45) {
                // Uncommon traits
                const uncommonTraits = Object.keys(workerTraits).filter(k => workerTraits[k].rarity === 'uncommon');
                return uncommonTraits[Math.floor(Math.random() * uncommonTraits.length)];
            } else {
                // Common traits
                const commonTraits = Object.keys(workerTraits).filter(k => workerTraits[k].rarity === 'common');
                return commonTraits[Math.floor(Math.random() * commonTraits.length)];
            }
        }
        
        function generateWorkerName() {
            const firstNames = ['Alex', 'Jordan', 'Sam', 'Casey', 'Morgan', 'Riley', 'Taylor', 'Jamie', 'Quinn', 'Avery', 
                               'Blake', 'Charlie', 'Drew', 'Finley', 'Harper', 'Kai', 'Logan', 'Oakley', 'River', 'Sage'];
            const lastNames = ['Smith', 'Stone', 'Wood', 'Fisher', 'Cooper', 'Miller', 'Carter', 'Reed', 'Brooks', 'Wells',
                              'Rivers', 'Fields', 'Forest', 'Hill', 'Dale', 'Vale', 'Shore', 'Creek', 'Meadow', 'Glen'];
            
            const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            
            return `${firstName} ${lastName}`;
        }

        function assignWorker(workerId, task) {
            const worker = gameState.workers.find(w => w.id === workerId);
            if (!worker) return;

            worker.task = task;
            worker.production = 0;
            
            showNotification(`Worker assigned to ${task}`, 'success');
            renderWorkers();
            updateUI();
        }

        function updateWorkers() {
            gameState.workers.forEach(worker => {
                if (worker.task) {
                    // Calculate effective speed
                    const effectiveStats = calculateWorkerEffectiveStats(worker);
                    const productionRate = effectiveStats.speedMultiplier;
                    
                    worker.production += productionRate;
                    
                    // Every 60 seconds of production
                    if (worker.production >= 60) {
                        const rewards = {
                            'Gather Wood': { wood: 3, stick: 1, silver: 8 },
                            'Mine Stone': { stone: 2, silver: 12 },
                            'Fish': { fish: 3, silver: 10 },
                            'Gather Herbs': { herbs: 2, silver: 15 },
                            'Mine Iron': { iron_ore: 1, silver: 20 },
                            'Mine Coal': { coal: 2, silver: 10 }
                        };

                        const baseReward = rewards[worker.task];
                        if (baseReward) {
                            // Apply output multiplier
                            let outputMultiplier = effectiveStats.outputMultiplier;
                            
                            // Apply output boost from shop
                            const outputBoost = hasActiveBoost('outputBoost');
                            if (outputBoost) {
                                outputMultiplier *= outputBoost;
                            }
                            
                            for (const [key, value] of Object.entries(baseReward)) {
                                const finalValue = Math.floor(value * outputMultiplier);
                                if (key === 'silver') {
                                    gameState.silver += finalValue;
                                    gameState.stats.silverEarned = (gameState.stats.silverEarned || 0) + finalValue;
                                    checkQuestProgress('silver_earned', null, finalValue);
                                } else {
                                    gameState.inventory[key] = (gameState.inventory[key] || 0) + finalValue;
                                    worker.totalProduced = (worker.totalProduced || 0) + finalValue;
                                    checkQuestProgress('worker_items', null, finalValue);
                                    checkQuestProgress('gather', key, finalValue);
                                }
                            }
                            
                            // Grant XP
                            const baseXP = 10;
                            let xpMultiplier = effectiveStats.xpMultiplier;
                            
                            // Apply XP boost from shop
                            const xpBoost = hasActiveBoost('xpBoost');
                            if (xpBoost) {
                                xpMultiplier *= xpBoost;
                            }
                            
                            const xpGained = Math.floor(baseXP * xpMultiplier);
                            worker.xp = (worker.xp || 0) + xpGained;
                            
                            // Check for level up
                            if (worker.xp >= worker.xpToNext) {
                                worker.level = (worker.level || 1) + 1;
                                worker.xp = worker.xp - worker.xpToNext;
                                worker.xpToNext = Math.floor(worker.xpToNext * 1.5); // 50% more XP per level
                                
                                showNotification(`${worker.name} reached level ${worker.level}!`, 'success');
                                playSound('level_up');
                                addActivity(`${worker.name} leveled up to ${worker.level}!`);
                            }
                        }

                        // Upkeep cost
                        gameState.silver -= worker.upkeep;
                        worker.production = 0;
                        
                        updateUI();
                        
                        // Re-render workers periodically to show XP updates
                        if (Math.random() < 0.1) { // 10% chance to avoid too many renders
                            renderWorkers();
                        }
                    }
                }
            });
        }

        function renderWorkers() {
            const container = document.getElementById('workersList');
            const maxWorkers = getMaxWorkerSlots();
            
            // Update capacity display
            const workerCountEl = document.getElementById('workerCount');
            const maxWorkersEl = document.getElementById('maxWorkers');
            if (workerCountEl) workerCountEl.textContent = gameState.workers.length;
            if (maxWorkersEl) maxWorkersEl.textContent = maxWorkers;
            
            if (gameState.workers.length === 0) {
                container.innerHTML = '<p class="card-description">No workers hired yet. Hire your first worker to start passive production!</p>';
                return;
            }

            container.innerHTML = gameState.workers.map(worker => {
                const workerType = workerTypes[worker.type || 'general'];
                const trait = workerTraits[worker.trait || 'average'];
                const durabilityPercent = (worker.production / 60) * 100;
                
                // Calculate effective stats
                const effectiveStats = calculateWorkerEffectiveStats(worker);
                
                // Trait rarity color
                const rarityColors = {
                    rare: 'var(--accent-gold)',
                    uncommon: 'var(--accent-blue)',
                    common: 'var(--text-secondary)'
                };
                
                return `
                <div class="worker-card">
                    <div class="worker-header">
                        <div>
                            <div class="worker-name">${workerType.icon} ${worker.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 3px;">
                                ${workerType.name} ‚Ä¢ Level ${worker.level || 1}
                            </div>
                        </div>
                        <div class="worker-status ${worker.task ? 'status-working' : 'status-idle'}">
                            ${worker.task ? 'Working' : 'Idle'}
                        </div>
                    </div>
                    
                    <!-- Trait Badge -->
                    <div style="display: inline-block; padding: 5px 12px; background: rgba(69, 123, 157, 0.2); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 15px;">
                        <span style="color: ${rarityColors[trait.rarity]};">${trait.icon} ${trait.name}</span>
                        <span style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 8px;">${trait.description}</span>
                    </div>
                    
                    <!-- XP Bar -->
                    <div class="progress-container" style="margin-bottom: 15px;">
                        <div class="progress-label">
                            <span>Experience</span>
                            <span>${worker.xp || 0} / ${worker.xpToNext || 100} XP</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${((worker.xp || 0) / (worker.xpToNext || 100)) * 100}%; background: linear-gradient(90deg, var(--accent-gold), var(--accent-green));"></div>
                        </div>
                    </div>
                    
                    <div class="card-stats" style="margin-bottom: 15px;">
                        <div class="stat-row">
                            <span class="stat-label">Current Task:</span>
                            <span class="stat-value">${worker.task || 'None'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Production:</span>
                            <span class="stat-value">${worker.production}/60s</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Upkeep:</span>
                            <span class="stat-value">${worker.upkeep} Silver/min</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Output Bonus:</span>
                            <span class="stat-value" style="color: var(--accent-green);">+${Math.round((effectiveStats.outputMultiplier - 1) * 100)}%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Speed Bonus:</span>
                            <span class="stat-value" style="color: var(--accent-blue);">+${Math.round((effectiveStats.speedMultiplier - 1) * 100)}%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Produced:</span>
                            <span class="stat-value">${worker.totalProduced || 0} items</span>
                        </div>
                    </div>
                    
                    <!-- Equipment Section -->
                    <div style="margin: 15px 0; padding: 15px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px;">
                        <div style="font-size: 0.9rem; font-weight: 700; margin-bottom: 10px; color: var(--accent-silver);">
                            ‚öôÔ∏è Equipment
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            ${renderEquipmentSlot(worker, 'hands', 'üß§')}
                            ${renderEquipmentSlot(worker, 'feet', 'ü•æ')}
                            ${renderEquipmentSlot(worker, 'head', '‚õëÔ∏è')}
                        </div>
                        <button class="btn btn-secondary" onclick="openWorkerEquipment(${worker.id})" style="margin-top: 10px; width: 100%;">
                            Manage Equipment
                        </button>
                    </div>
                    
                    ${worker.task ? `
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${(worker.production / 60) * 100}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="assignWorker(${worker.id}, 'Gather Wood')">
                            ü™µ Wood
                        </button>
                        <button class="btn btn-secondary" onclick="assignWorker(${worker.id}, 'Mine Stone')">
                            ‚õèÔ∏è Stone
                        </button>
                        <button class="btn btn-secondary" onclick="assignWorker(${worker.id}, 'Fish')">
                            üé£ Fish
                        </button>
                        <button class="btn btn-secondary" onclick="assignWorker(${worker.id}, 'Gather Herbs')">
                            üåø Herbs
                        </button>
                        <button class="btn btn-secondary" onclick="assignWorker(${worker.id}, 'Mine Iron')">
                            ‚öôÔ∏è Iron
                        </button>
                        <button class="btn btn-secondary" onclick="assignWorker(${worker.id}, 'Mine Coal')">
                            ‚ö´ Coal
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="unassignWorker(${worker.id})" ${!worker.task ? 'disabled' : ''}>
                            Stop Working
                        </button>
                        <button class="btn btn-secondary" onclick="fireWorker(${worker.id})" style="border-color: var(--accent-red); color: var(--accent-red);">
                            Fire Worker
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function renderEquipmentSlot(worker, slot, icon) {
            if (!worker.equipment) worker.equipment = { hands: null, feet: null, head: null };
            const equipmentKey = worker.equipment[slot];
            
            if (equipmentKey) {
                const equipData = workerEquipment[equipmentKey];
                const durabilityPercent = 100; // Simplified for now
                
                return `
                    <div style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--accent-blue); border-radius: 6px; text-align: center;">
                        <div style="font-size: 1.2rem;">${icon}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${equipData.name}</div>
                        <div style="font-size: 0.7rem; color: var(--accent-green);">
                            ${Math.round(durabilityPercent)}%
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div style="padding: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; text-align: center; opacity: 0.5;">
                        <div style="font-size: 1.2rem;">${icon}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Empty</div>
                    </div>
                `;
            }
        }
        
        function calculateWorkerEffectiveStats(worker) {
            let outputMultiplier = 1.0;
            let speedMultiplier = 1.0;
            let xpMultiplier = 1.0;
            
            // Worker type bonuses
            const workerType = workerTypes[worker.type || 'general'];
            if (worker.task && workerType.bonuses[worker.task]) {
                outputMultiplier *= workerType.bonuses[worker.task];
            }
            
            // Level bonus (5% per level)
            const level = worker.level || 1;
            outputMultiplier *= (1 + (level - 1) * 0.05);
            
            // Trait effects
            const trait = workerTraits[worker.trait || 'average'];
            if (trait.effect.output) {
                outputMultiplier *= trait.effect.output;
            }
            if (trait.effect.speed) {
                speedMultiplier *= trait.effect.speed;
            }
            if (trait.effect.xp) {
                xpMultiplier *= trait.effect.xp;
            }
            if (trait.effect.specialized && worker.task) {
                outputMultiplier *= 1.3;
            }
            
            // Equipment bonuses
            if (worker.equipment) {
                for (const slot of Object.keys(worker.equipment)) {
                    const equipmentKey = worker.equipment[slot];
                    if (equipmentKey && workerEquipment[equipmentKey]) {
                        const equipment = workerEquipment[equipmentKey];
                        if (equipment.bonus.output) {
                            outputMultiplier *= equipment.bonus.output;
                        }
                        if (equipment.bonus.speed) {
                            speedMultiplier *= equipment.bonus.speed;
                        }
                    }
                }
            }
            
            return { outputMultiplier, speedMultiplier, xpMultiplier };
        }
        
        function unassignWorker(workerId) {
            const worker = gameState.workers.find(w => w.id === workerId);
            if (!worker) return;
            
            worker.task = null;
            worker.production = 0;
            
            showNotification(`${worker.name} is now idle`, 'success');
            renderWorkers();
        }
        
        function fireWorker(workerId) {
            if (!confirm('Are you sure you want to fire this worker?')) return;
            
            const worker = gameState.workers.find(w => w.id === workerId);
            if (!worker) return;
            
            gameState.workers = gameState.workers.filter(w => w.id !== workerId);
            
            showNotification(`Fired ${worker.name}`, 'success');
            addActivity(`Fired worker: ${worker.name}`);
            renderWorkers();
            updateUI();
        }
        
        function openWorkerEquipment(workerId) {
            const worker = gameState.workers.find(w => w.id === workerId);
            if (!worker) return;
            
            const dialog = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;" id="equipmentDialog" onclick="closeEquipmentDialog(event)">
                    <div class="screen" style="max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h2 class="screen-title">‚öôÔ∏è Equipment for ${worker.name}</h2>
                        
                        <div style="margin: 20px 0;">
                            <h3 class="card-title">Available Equipment</h3>
                            ${Object.entries(workerEquipment).map(([key, equipment]) => {
                                const isEquipped = worker.equipment && Object.values(worker.equipment).includes(key);
                                
                                return `
                                    <div class="market-item" style="margin-bottom: 10px;">
                                        <div class="market-info">
                                            <div class="market-item-name">${equipment.icon} ${equipment.name}</div>
                                            <div class="market-item-details">
                                                Slot: ${equipment.slot} ‚Ä¢ 
                                                ${Object.entries(equipment.bonus).map(([k, v]) => 
                                                    `${k}: +${Math.round((v - 1) * 100)}%`
                                                ).join(', ')}
                                            </div>
                                        </div>
                                        <div class="market-price">${equipment.cost} ü•à</div>
                                        <button class="btn ${isEquipped ? 'btn-secondary' : 'btn-primary'}" 
                                                onclick="equipWorker(${workerId}, '${key}')" 
                                                ${isEquipped ? 'disabled' : ''}>
                                            ${isEquipped ? 'Equipped' : 'Equip'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <button class="btn btn-secondary" onclick="closeEquipmentDialog()">Close</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialog);
        }
        
        function closeEquipmentDialog(event) {
            if (event && event.target.id !== 'equipmentDialog') return;
            const dialog = document.getElementById('equipmentDialog');
            if (dialog) dialog.remove();
        }
        
        function equipWorker(workerId, equipmentKey) {
            const worker = gameState.workers.find(w => w.id === workerId);
            const equipment = workerEquipment[equipmentKey];
            
            if (!worker || !equipment) return;
            
            // Check if can afford
            if (gameState.silver < equipment.cost) {
                showNotification('Not enough Silver!', 'error');
                return;
            }
            
            // Initialize equipment if needed
            if (!worker.equipment) {
                worker.equipment = { hands: null, feet: null, head: null };
            }
            
            // Check if slot already occupied
            if (worker.equipment[equipment.slot]) {
                showNotification(`${equipment.slot} slot already equipped! Unequip first.`, 'error');
                return;
            }
            
            gameState.silver -= equipment.cost;
            gameState.stats.silverSpent = (gameState.stats.silverSpent || 0) + equipment.cost;
            
            // Equip
            worker.equipment[equipment.slot] = equipmentKey;
            
            showNotification(`Equipped ${equipment.name} on ${worker.name}!`, 'success');
            addActivity(`Equipped ${equipment.name} on ${worker.name} for ${equipment.cost} Silver`);
            
            closeEquipmentDialog();
            renderWorkers();
            updateUI();
        }

        function updateUI() {
            // Update currency display
            document.getElementById('silverAmount').textContent = gameState.silver;
            document.getElementById('goldAmount').textContent = gameState.gold;

            // Update city stats
            document.getElementById('totalActions').textContent = gameState.stats.totalActions;
            document.getElementById('totalItems').textContent = 
                Object.values(gameState.inventory).reduce((a, b) => a + b, 0);
            document.getElementById('itemsCrafted').textContent = gameState.stats.itemsCrafted || 0;
            document.getElementById('tradesMade').textContent = gameState.stats.tradesMade || 0;
            document.getElementById('activeWorkers').textContent = 
                `${gameState.workers.filter(w => w.task).length}/${gameState.workers.length}`;
            document.getElementById('marketListings').textContent = gameState.marketListings.length;
            
            const biomeName = biomes[gameState.progress.currentBiome]?.name || 'Forest';
            document.getElementById('currentBiome').textContent = biomeName;
            
            // Economy stats
            const silverEarned = gameState.stats.silverEarned || 0;
            const silverSpent = gameState.stats.silverSpent || 0;
            const netProfit = silverEarned - silverSpent;
            
            const earnedEl = document.getElementById('silverEarned');
            const spentEl = document.getElementById('silverSpent');
            const profitEl = document.getElementById('netProfit');
            const nextTaxEl = document.getElementById('nextTaxDisplay');
            
            if (earnedEl) earnedEl.textContent = `${silverEarned} ü•à`;
            if (spentEl) spentEl.textContent = `${silverSpent} ü•à`;
            if (profitEl) {
                profitEl.textContent = `${netProfit} ü•à`;
                profitEl.style.color = netProfit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
            
            // Tax timer
            if (nextTaxEl && gameState.economy.lastTaxPayment) {
                const timeSinceLastTax = Date.now() - gameState.economy.lastTaxPayment;
                const taxPeriod = 300000; // 5 minutes
                const timeUntilTax = taxPeriod - (timeSinceLastTax % taxPeriod);
                const minutes = Math.floor(timeUntilTax / 60000);
                const seconds = Math.floor((timeUntilTax % 60000) / 1000);
                nextTaxEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            // Update island
            document.getElementById('islandLevel').textContent = gameState.island.level;
            document.getElementById('islandBuildings').textContent = gameState.island.buildings;
            document.getElementById('islandBonus').textContent = `+${gameState.island.buildings * 10} Silver`;
            
            // Check for biome unlocks
            updateBiomeSelector();
        }

        function addActivity(message) {
            const timestamp = new Date().toLocaleTimeString();
            gameState.activityLog.unshift({ message, timestamp });
            
            // Keep only last 10 activities
            if (gameState.activityLog.length > 10) {
                gameState.activityLog.pop();
            }

            const container = document.getElementById('recentActivity');
            container.innerHTML = gameState.activityLog.map(activity => `
                <div style="padding: 8px 0; border-bottom: 1px solid ${getComputedStyle(document.documentElement).getPropertyValue('--border-color')};">
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${activity.timestamp}</div>
                    <div style="font-size: 0.9rem;">${activity.message}</div>
                </div>
            `).join('');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function saveGame(auto = false) {
            try {
                localStorage.setItem('gcabWorld_save', JSON.stringify(gameState));
                const now = new Date().toLocaleString();
                document.getElementById('lastSave').textContent = now;
                
                if (!auto) {
                    showNotification('Game saved successfully!', 'success');
                }
            } catch (e) {
                showNotification('Failed to save game', 'error');
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('gcabWorld_save');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    
                    // Merge saved data with defaults for backward compatibility
                    gameState.silver = loaded.silver || 1000;
                    gameState.gold = loaded.gold || 10;
                    
                    // Merge inventory
                    gameState.inventory = { ...gameState.inventory, ...loaded.inventory };
                    
                    // Merge tools - ensure basic tools exist
                    if (loaded.tools) {
                        gameState.tools = loaded.tools;
                    }
                    // Ensure basic tools exist if not present
                    if (!gameState.tools.basic_axe) {
                        gameState.tools.basic_axe = { durability: 100, maxDurability: 100 };
                    }
                    if (!gameState.tools.basic_pickaxe) {
                        gameState.tools.basic_pickaxe = { durability: 100, maxDurability: 100 };
                    }
                    if (!gameState.tools.basic_fishing_rod) {
                        gameState.tools.basic_fishing_rod = { durability: 100, maxDurability: 100 };
                    }
                    
                    // Update workers with new properties
                    gameState.workers = (loaded.workers || []).map(worker => ({
                        ...worker,
                        type: worker.type || 'general',
                        level: worker.level || 1,
                        xp: worker.xp || 0,
                        xpToNext: worker.xpToNext || 100,
                        trait: worker.trait || 'average',
                        equipment: worker.equipment || { hands: null, feet: null, head: null },
                        totalProduced: worker.totalProduced || 0
                    }));
                    
                    gameState.marketListings = loaded.marketListings || [];
                    gameState.activeActions = {}; // Don't restore active actions
                    gameState.activityLog = loaded.activityLog || [];
                    gameState.island = loaded.island || { level: 1, buildings: 0 };
                    
                    // Merge stats
                    gameState.stats = { ...gameState.stats, ...loaded.stats };
                    if (!gameState.stats.itemsCrafted) gameState.stats.itemsCrafted = 0;
                    if (!gameState.stats.tradesMade) gameState.stats.tradesMade = 0;
                    if (!gameState.stats.silverSpent) gameState.stats.silverSpent = 0;
                    if (!gameState.stats.silverEarned) gameState.stats.silverEarned = 0;
                    
                    // Progress data
                    gameState.progress = loaded.progress || {
                        currentBiome: 'forest',
                        unlockedBiomes: ['forest'],
                        tier: 1
                    };
                    
                    // Economy data
                    if (loaded.economy) {
                        gameState.economy = {
                            ...gameState.economy,
                            ...loaded.economy,
                            currentEvent: null, // Don't restore active events
                            eventEndTime: null
                        };
                    }
                    
                    // Quests data
                    if (loaded.quests) {
                        gameState.quests = {
                            ...gameState.quests,
                            ...loaded.quests
                        };
                    }
                    
                    // Achievements data
                    if (loaded.achievements) {
                        gameState.achievements = loaded.achievements;
                    }
                    
                    // Shop data
                    if (loaded.shop) {
                        gameState.shop = {
                            ...gameState.shop,
                            ...loaded.shop
                        };
                    }
                    
                    // Character data
                    if (loaded.character) {
                        gameState.character = {
                            ...gameState.character,
                            ...loaded.character
                        };
                    }
                    
                    // Note: Wallet data is NOT persisted for security reasons
                    // Users must reconnect their wallet each session
                    
                    // Audio data
                    if (loaded.audio) {
                        gameState.audio = {
                            ...gameState.audio,
                            ...loaded.audio
                        };
                    }
                    
                    updateUI();
                    renderWorkers();
                    renderMarket();
                    renderTools();
                    renderCraftingRecipes();
                    renderBiomeActions();
                    updateBiomeSelector();
                    
                    // Don't show notification on initial load
                    if (loaded.stats && loaded.stats.totalActions > 0) {
                        showNotification('Game loaded!', 'success');
                    }
                }
            } catch (e) {
                console.error('Failed to load game', e);
                showNotification('Failed to load game - starting fresh', 'error');
            }
        }

        function resetGame() {
            if (confirm('Are you sure you want to reset? All progress will be lost!')) {
                localStorage.removeItem('gcabWorld_save');
                location.reload();
            }
        }

        // Initialize game on load
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>